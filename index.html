<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nini Mayorista App</title>
    
    <!-- 1. ESTILOS (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. MOTOR (React & ReactDOM) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. TRADUCTOR (Babel para entender el código) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Ajustes para que se sienta como App nativa */
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px; } /* Evita zoom en iPhone */
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- AQUÍ SE MONTA TU APP -->
    <div id="root"></div>

    <!-- CÓDIGO DE LA APP -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        // --- ICONOS (SVG INLINE PARA NO DEPENDER DE LIBRERÍAS EXTERNAS) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        
        const Icons = {
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Plus: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Minus: (p) => <Icon {...p} path={<path d="M5 12h14"/>} />,
            Lock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            Unlock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>} />,
            Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>} />,
            PieChart: (p) => <Icon {...p} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />,
            Database: (p) => <Icon {...p} path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            Copy: (p) => <Icon {...p} path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>} />,
            ChevronDown: (p) => <Icon {...p} path={<path d="m6 9 6 6 6-6"/>} />,
            ChevronUp: (p) => <Icon {...p} path={<path d="m18 15-6-6-6 6"/>} />,
            AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />,
        };

        // --- CONFIGURACIÓN ---
        const SHEET_ID = "1Yz_Br2J41diPtd-PL8lLE_Q8eQex-Vf7ifkIqdEqQEQ";
        // Usamos una URL proxy para evitar problemas de CORS o caché en algunos navegadores, o directo a Google
        const LINK_HOJA_PRODUCTOS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_PRODUCTOS`; 
        const LINK_HOJA_HISTORIAL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_HISTORIAL`;

        const COLORS = {
            blue: '#004aad',
            red: '#e31d2b',
            bg: '#f8f9fa',
            barColor1: '#93C5FD', 
            barColor2: '#60A5FA', 
            pastelGray: '#E5E7EB',
            chartColors: ['#93C5FD', '#FCA5A5', '#86EFAC', '#FDE047', '#D8B4FE', '#F9A8D4', '#67E8F9', '#C4B5FD']
        };

        const INITIAL_PRODUCTS = [
            { id: '101', name: 'Cargando...', brand: '...', category: 'General', price: 0, plannedQty: 0, actualQty: 0 },
        ];

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen p-6 text-center bg-gray-50">
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-red-100">
                                <Icons.AlertTriangle className="text-red-500 w-12 h-12 mx-auto mb-4" />
                                <h2 className="text-xl font-bold text-gray-800 mb-2">Algo salió mal</h2>
                                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-red-600 transition">
                                    REINICIAR APP
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- COMPONENTE PRINCIPAL ---
        function NiniApp() {
            const [activeTab, setActiveTab] = useState('list'); 
            const [products, setProducts] = useState(() => {
                try {
                    const saved = localStorage.getItem('nini_current_list');
                    if (saved) return JSON.parse(saved);
                } catch(e) {}
                return INITIAL_PRODUCTS;
            });
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [filter, setFilter] = useState('Todos'); 
            const [brandFilter, setBrandFilter] = useState('Todas');
            const [showBrandFilter, setShowBrandFilter] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [isLocked, setIsLocked] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportContent, setExportContent] = useState('');

            // -- UTILS --
            const cleanCSVValue = (text) => (typeof text === 'string' ? text.replace(/^"|"$/g, '').replace('$', '').trim() : "");
            const parseNumberAR = (str) => {
                if (!str) return 0;
                if (typeof str === 'number') return str;
                const strVal = String(str);
                if (strVal.includes('.') && !strVal.includes(',')) return parseFloat(strVal) || 0;
                return parseFloat(strVal.replace(/\./g, '').replace(',', '.')) || 0;
            };

            // -- LOADERS --
            const fetchProducts = async () => {
                if(products === INITIAL_PRODUCTS) setStatusMsg('Conectando...');
                try {
                    const res = await fetch(LINK_HOJA_PRODUCTOS_URL);
                    const txt = await res.text();
                    if(txt.includes('<html')) throw new Error("Privado");
                    const lines = txt.split('\n').slice(1);
                    const newProds = [];
                    lines.forEach((l, i) => {
                        const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanCSVValue);
                        if(c.length < 2) return;
                        const id = c[0] || `r${i}`;
                        const name = c[1];
                        if(!name || name === 'Sin Nombre') return;
                        
                        const existing = Array.isArray(products) ? products.find(p => p.id === id || p.name === name) : null;
                        newProds.push({
                            id, name, 
                            brand: c[2] || 'Generico', category: c[3] || 'Varios', 
                            price: parseNumberAR(c[4]),
                            plannedQty: existing?.plannedQty || 0,
                            actualQty: existing?.actualQty || 0
                        });
                    });
                    if(newProds.length > 0) {
                        setProducts(prev => {
                            // Merge conservando cantidades
                            const merged = newProds.map(np => {
                                const local = prev.find(p => p.id === np.id || p.name === np.name);
                                return local ? { ...np, plannedQty: local.plannedQty, actualQty: local.actualQty } : np;
                            });
                            return merged;
                        });
                        setStatusMsg('¡Actualizado!');
                        setTimeout(()=>setStatusMsg(''), 2000);
                    }
                } catch(e) { console.warn(e); setStatusMsg(''); }
            };

            const fetchHistory = async () => {
                setLoading(true);
                try {
                    const res = await fetch(LINK_HOJA_HISTORIAL_URL);
                    const txt = await res.text();
                    const lines = txt.split('\n');
                    const headerIdx = lines.findIndex(l => l.toLowerCase().includes('fecha'));
                    const dataLines = headerIdx !== -1 ? lines.slice(headerIdx + 1) : lines;
                    const groups = {};
                    
                    dataLines.forEach(l => {
                        const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanCSVValue);
                        if(c.length < 5) return;
                        const date = c[0]; const name = c[1];
                        if(!date || !name) return;
                        if(!groups[date]) groups[date] = { total: 0, items: [] };
                        const qty = parseNumberAR(c[4]); const price = parseNumberAR(c[5]);
                        groups[date].items.push({ name, brand: c[2], category: c[3]||'Varios', actualQty: qty, price });
                        groups[date].total += qty * price;
                    });

                    const parsed = Object.keys(groups).map(dStr => {
                        let isoDate = new Date().toISOString();
                        try {
                            if(dStr.includes('/')) {
                                const [d,m,y] = dStr.split('/');
                                const fullYear = y.length === 2 ? `20${y}` : y;
                                const dateObj = new Date(`${fullYear}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T12:00:00`);
                                if(!isNaN(dateObj)) isoDate = dateObj.toISOString();
                            } else if (dStr.includes('-')) {
                                const dateObj = new Date(dStr);
                                if(!isNaN(dateObj)) isoDate = dateObj.toISOString();
                            }
                        } catch(e){}
                        return { id: dStr + Math.random(), date: isoDate, displayDate: dStr, total: groups[dStr].total, items: groups[dStr].items };
                    }).sort((a,b) => new Date(b.date) - new Date(a.date));
                    
                    setHistory(parsed);
                } catch(e) { console.error(e); } finally { setLoading(false); }
            };

            useEffect(() => { fetchProducts(); }, []);
            useEffect(() => { if(activeTab === 'history') fetchHistory(); }, [activeTab]);
            useEffect(() => { localStorage.setItem('nini_current_list', JSON.stringify(products)); }, [products]);

            // -- COMPUTED --
            const safeProducts = Array.isArray(products) ? products : INITIAL_PRODUCTS;
            const dynamicCategories = useMemo(() => ['Todos', ...Array.from(new Set(safeProducts.map(p => p.category || 'Varios'))).sort()], [safeProducts]);
            const availableBrands = useMemo(() => Array.from(new Set(safeProducts.filter(p => filter === 'Todos' || p.category === filter).map(p => p.brand || 'Genérico'))).sort(), [safeProducts, filter]);
            
            const filteredProducts = safeProducts.filter(p => {
                const matchCat = filter === 'Todos' || p.category === filter;
                const matchBrand = brandFilter === 'Todas' || p.brand === brandFilter;
                const matchSearch = (p.name||'').toLowerCase().includes(searchTerm.toLowerCase());
                return matchCat && matchBrand && matchSearch;
            });

            const totalBudget = safeProducts.reduce((acc, p) => acc + (p.price * p.plannedQty), 0);
            const totalSpent = safeProducts.reduce((acc, p) => acc + (p.price * p.actualQty), 0);

            // -- ACTIONS --
            const handleQty = (id, d, field) => {
                if(field === 'plannedQty' && isLocked) return;
                setProducts(prev => prev.map(p => p.id === id ? { ...p, [field]: Math.max(0, p[field] + d) } : p));
            };
            
            const handleFinish = () => {
                const items = safeProducts.filter(p => p.actualQty > 0);
                if(items.length === 0) return alert("Carrito vacío");
                const date = new Date().toLocaleDateString('es-AR');
                let txt = "";
                items.forEach(p => { txt += `${date}\t${p.name}\t${p.brand}\t${p.category}\t${p.actualQty}\t${p.price}\t${p.actualQty * p.price}\n`; });
                setExportContent(txt);
                setShowExportModal(true);
            };

            const copyToClip = () => {
                document.getElementById('exportarea').select();
                document.execCommand('copy');
                alert("¡Copiado! Pega en el Excel (Columna A).");
            };

            // -- RENDER --
            return (
                <div className="min-h-screen pb-20 font-sans flex flex-col" style={{ backgroundColor: COLORS.bg }}>
                    {/* Header */}
                    <div className="sticky top-0 z-40 bg-white shadow-md border-b border-gray-200">
                        <div className="flex justify-between items-center px-4 py-3" style={{ background: `linear-gradient(135deg, ${COLORS.blue} 0%, #002a60 100%)` }}>
                            <div className="flex flex-col leading-none">
                                <div className="font-black text-2xl tracking-tighter flex items-baseline select-none">
                                    <span className="text-white">n</span><span style={{color: COLORS.red}}>i</span>
                                    <span className="text-white">n</span><span style={{color: COLORS.red}}>i</span>
                                </div>
                                <span className="text-[9px] font-bold uppercase tracking-widest -mt-1 text-blue-200">mayorista</span>
                            </div>
                            {activeTab === 'list' && (
                                <div className="flex gap-4 text-right items-center text-white">
                                    <div><div className="text-[9px] text-blue-200 font-bold uppercase">Plan</div><div className="text-sm font-semibold">${totalBudget}</div></div>
                                    <div><div className="text-[9px] text-blue-200 font-bold uppercase">Carrito</div><div className="text-lg font-bold text-white">${totalSpent}</div></div>
                                    <button onClick={handleFinish} className="ml-1 bg-white text-blue-800 p-2 rounded-full shadow-lg active:scale-95 hover:bg-gray-100"><Icons.Save size={18}/></button>
                                </div>
                            )}
                            {activeTab === 'history' && <div className="text-xs font-bold text-blue-200 flex items-center gap-1 bg-white/10 px-2 py-1 rounded"><Icons.Database size={12}/> Conectado</div>}
                        </div>

                        {/* Filtros */}
                        {activeTab === 'list' && (
                            <div className="flex flex-col bg-gray-50 border-t border-gray-100">
                                <div className="flex items-center gap-2 px-3 py-2">
                                    <button onClick={() => setIsLocked(!isLocked)} className={`flex items-center justify-center w-8 h-8 rounded text-xs font-bold ${isLocked ? 'bg-orange-100 text-orange-700' : 'bg-white text-green-700 border'}`}>{isLocked ? <Icons.Lock size={16} /> : <Icons.Unlock size={16} />}</button>
                                    <div className="relative flex-1"><div className="absolute left-2 top-2"><Icons.Search className="text-gray-400" size={16}/></div><input type="text" placeholder="Buscar..." className="w-full pl-8 pr-2 py-1.5 text-sm bg-white border rounded focus:outline-none" onChange={e => setSearchTerm(e.target.value)} /></div>
                                    <button onClick={() => setShowBrandFilter(!showBrandFilter)} className={`flex items-center justify-center w-8 h-8 rounded border transition-colors ${showBrandFilter ? 'bg-blue-100 text-blue-700' : 'bg-white text-gray-500'}`}><Icons.Filter size={16} /></button>
                                    <button onClick={() => setProducts(prev => prev.map(p=>({...p, actualQty:0})))} className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500"><Icons.Trash2 size={16}/></button>
                                </div>
                                {showBrandFilter && <div className="px-3 py-2 bg-blue-50 border-b"><div className="text-[10px] font-bold text-blue-800 mb-1 uppercase">Marca</div><select value={brandFilter} onChange={(e) => setBrandFilter(e.target.value)} className="w-full p-2 text-sm border rounded"><option value="Todas">Todas</option>{availableBrands.map(b => <option key={b} value={b}>{b}</option>)}</select></div>}
                                <div className="overflow-x-auto whitespace-nowrap px-3 py-1 bg-white border-b no-scrollbar">{dynamicCategories.map(cat => (<button key={cat} onClick={() => setFilter(cat)} className={`text-[11px] font-bold px-3 py-1 rounded-full mr-1 transition-colors ${filter === cat ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>{cat}</button>))}</div>
                                <div className="flex text-[10px] text-gray-400 font-bold px-3 py-1 bg-gray-50 border-b uppercase tracking-wider shadow-sm"><div className="flex-1">Producto</div><div className="w-16 text-center">Plan</div><div className="w-24 text-center">Carrito</div></div>
                            </div>
                        )}
                        {statusMsg && <div className="bg-blue-600 text-white text-[10px] py-1 px-3 text-center font-bold">{statusMsg}</div>}
                    </div>

                    {/* Scroll Area */}
                    <div className="flex-1 overflow-y-auto">
                        {activeTab === 'list' ? (
                            <div className="w-full pb-8">
                                {filteredProducts.map(p => (
                                    <div key={p.id} className={`flex items-center px-3 py-2 border-b transition-colors ${p.actualQty >= p.plannedQty && p.plannedQty > 0 ? 'bg-green-50/60' : 'bg-white'}`}>
                                        <div className="flex-1 min-w-0 pr-2">
                                            <div className="flex flex-col"><span className="text-sm font-bold truncate">{p.name}</span><span className="text-[10px] text-gray-500 truncate font-semibold">{p.brand}</span></div>
                                            <div className="flex items-center gap-1 mt-0.5"><span className="text-xs text-gray-400">$</span><input type="number" className="text-xs font-medium text-gray-600 w-16 bg-transparent border-b focus:outline-none" value={p.price} onChange={e => { const val = Number(e.target.value); setProducts(prev => prev.map(i => i.id === p.id ? { ...i, price: val } : i)); }} /></div>
                                        </div>
                                        <div className={`w-16 flex items-center justify-center border-x px-1 ${isLocked ? 'opacity-50' : ''}`}>
                                            {!isLocked && <button onClick={() => handleQty(p.id, -1, 'plannedQty')} className="px-1 text-gray-400"><Icons.Minus size={10}/></button>}
                                            <span className="text-sm font-bold w-full text-center">{p.plannedQty}</span>
                                            {!isLocked && <button onClick={() => handleQty(p.id, 1, 'plannedQty')} className="px-1 text-gray-400"><Icons.Plus size={10}/></button>}
                                        </div>
                                        <div className="w-24 flex items-center justify-between pl-2">
                                            <button onClick={() => handleQty(p.id, -1, 'actualQty')} className="w-7 h-7 flex items-center justify-center bg-white border rounded active:bg-gray-100"><Icons.Minus size={14}/></button>
                                            <span className={`text-lg font-bold ${p.actualQty >= p.plannedQty && p.plannedQty > 0 ? 'text-green-600' : 'text-blue-900'}`}>{p.actualQty}</span>
                                            <button onClick={() => handleQty(p.id, 1, 'actualQty')} className="w-7 h-7 flex items-center justify-center bg-blue-600 text-white rounded active:scale-95"><Icons.Plus size={14}/></button>
                                        </div>
                                    </div>
                                ))}
                                {filteredProducts.length === 0 && <div className="text-center py-8 text-gray-400">Sin productos.</div>}
                            </div>
                        ) : (
                            <HistoryView history={history} loading={loading} />
                        )}
                    </div>

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-md flex flex-col max-h-[80vh]">
                                <div className="p-4 border-b flex justify-between"><h3 className="font-bold">Copiar al Excel</h3><button onClick={() => setShowExportModal(false)}><Icons.X size={20}/></button></div>
                                <div className="p-4 flex-1 bg-gray-50"><textarea id="exportarea" readOnly value={exportContent} className="w-full h-32 p-2 text-xs border rounded mb-2" onClick={e => e.target.select()} /><button onClick={copyToClip} className="w-full py-2 bg-green-600 text-white font-bold rounded">COPIAR AHORA</button></div>
                                <div className="p-4 border-t"><button onClick={() => { setProducts(prev => prev.map(p => ({...p, actualQty:0}))); setShowExportModal(false); }} className="w-full py-2 text-blue-600 font-bold border border-blue-600 rounded">Limpiar Carrito</button></div>
                            </div>
                        </div>
                    )}

                    {/* Navbar */}
                    <div className="fixed bottom-0 w-full flex justify-around items-center pb-safe z-50 h-16 shadow-lg" style={{ backgroundColor: COLORS.blue }}>
                        <button onClick={() => setActiveTab('list')} className={`flex flex-col items-center justify-center w-full h-full ${activeTab === 'list' ? 'text-white' : 'text-white/50'}`}><Icons.List size={24} strokeWidth={2.5} /><span className="text-[10px] font-bold mt-1">Lista</span></button>
                        <div className="w-px h-8 bg-white/20"></div>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center justify-center w-full h-full ${activeTab === 'history' ? 'text-white' : 'text-white/50'}`}><Icons.PieChart size={24} strokeWidth={2.5} /><span className="text-[10px] font-bold mt-1">Historial</span></button>
                    </div>
                </div>
            );
        }

        // --- HISTORIAL VIEW ---
        function HistoryView({ history, loading }) {
            const [filterDate, setFilterDate] = useState('all');
            const [expandedId, setExpandedId] = useState(null);

            // HOOKS FIRST (ORDER MATTERS)
            const availableMonths = useMemo(() => {
                if(!history) return [];
                const unique = new Set();
                history.forEach(h => {
                    const d = new Date(h.date);
                    if(!isNaN(d)) unique.add(JSON.stringify({ value: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`, label: d.toLocaleString('es-AR', { month: 'long', year: 'numeric' }) }));
                });
                return Array.from(unique).map(s => JSON.parse(s)).sort((a,b) => b.value.localeCompare(a.value));
            }, [history]);

            const pieData = useMemo(() => {
                if(!history) return [];
                const source = filterDate === 'all' ? history : history.filter(h => h.date.startsWith(filterDate));
                const catMap = {}; let total = 0;
                source.forEach(h => {
                    if(h.items) h.items.forEach(i => {
                        const sub = (i.actualQty||0)*(i.price||0);
                        catMap[i.category] = (catMap[i.category] || 0) + sub;
                        total += sub;
                    });
                });
                return Object.entries(catMap).map(([k,v]) => ({ name: k, value: v, percent: total ? (v/total)*100 : 0 })).sort((a,b)=>b.value-a.value);
            }, [history, filterDate]);

            const monthlyData = useMemo(() => {
                if(!history) return [];
                const months = Array.from({length: 12}, (_, i) => ({ label: new Date(2024, i, 1).toLocaleString('es-AR', { month: 'short' }).toUpperCase(), total: 0 }));
                history.forEach(h => { const d = new Date(h.date); if(!isNaN(d)) months[d.getMonth()].total += h.total; });
                return months;
            }, [history]);

            // CONDITIONAL RETURNS AFTER HOOKS
            if (loading) return <div className="flex flex-col items-center justify-center h-[60vh] text-blue-500">Cargando...</div>;
            if (!history || history.length === 0) return <div className="flex flex-col items-center justify-center h-[60vh] text-gray-400">Sin datos</div>;

            const maxMonthly = Math.max(...monthlyData.map(d => d.total), 1);
            const pieGradient = pieData.length > 0 ? pieData.reduce((acc, cat, idx) => {
                const prev = pieData.slice(0, idx).reduce((p, c) => p + c.percent, 0);
                const color = COLORS.chartColors[idx % COLORS.chartColors.length];
                return `${acc}, ${color} ${prev}% ${prev + cat.percent}%`;
            }, '').slice(2) : '#ddd 0% 100%';

            return (
                <div className="p-4 space-y-6 pb-24">
                    {/* Torta */}
                    <div className="bg-white rounded-xl shadow-sm border p-4">
                        <div className="flex justify-between items-start mb-4">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2"><Icons.PieChart size={18} className="text-blue-500"/> Gasto por Rubro</h3>
                            <div className="relative">
                                <select value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="appearance-none bg-gray-100 text-gray-700 text-xs font-bold py-1 pl-3 pr-8 rounded-lg border focus:outline-none">
                                    <option value="all">Todo el Año</option>
                                    {availableMonths.map(m => (<option key={m.value} value={m.value}>{m.label}</option>))}
                                </select>
                                <Icons.ChevronDown size={14} className="absolute right-2 top-1.5 text-gray-500 pointer-events-none" />
                            </div>
                        </div>
                        <div className="flex flex-row items-center gap-4">
                            <div className="w-32 h-32 rounded-full relative shadow-inner flex-shrink-0" style={{ background: `conic-gradient(${pieGradient})` }}><div className="absolute inset-8 bg-white rounded-full flex items-center justify-center flex-col"><span className="text-[9px] text-gray-400 font-bold uppercase">TOTAL</span><span className="text-xs font-bold text-gray-700">${Math.round(pieData.reduce((a,b)=>a+b.value,0)/1000)}k</span></div></div>
                            <div className="flex-1 space-y-1">
                                {pieData.slice(0,5).map((cat, idx) => (
                                    <div key={idx} className="flex justify-between items-center text-xs"><div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.chartColors[idx % COLORS.chartColors.length] }}></div><span className="text-gray-600 truncate max-w-[80px]">{cat.name}</span></div><span className="font-bold">{Math.round(cat.percent)}%</span></div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Barras */}
                    <div className="bg-white rounded-xl shadow-sm border p-4">
                        <h3 className="font-bold text-gray-700 mb-4">Evolución Anual</h3>
                        <div className="flex items-end gap-1 h-32 border-b pb-2">
                            {monthlyData.map((d, i) => (
                                <div key={i} className="flex-1 flex flex-col items-center gap-1 h-full justify-end group">
                                    <div className="w-full relative flex items-end justify-center h-full">
                                        <div className="w-full rounded-t-sm transition-all relative" style={{ height: d.total > 0 ? `${(d.total/maxMonthly)*100}%` : '4px', backgroundColor: d.total > 0 ? (i%2===0 ? COLORS.barColor1 : COLORS.barColor2) : COLORS.pastelGray }}>
                                            {d.total > 0 && <div className="opacity-0 group-hover:opacity-100 absolute -top-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[9px] px-1 rounded pointer-events-none">${Math.round(d.total/1000)}k</div>}
                                        </div>
                                    </div>
                                    <span className={`text-[8px] font-bold uppercase ${d.total > 0 ? 'text-gray-700' : 'text-gray-300'}`}>{d.label}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Lista Acordeon */}
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="bg-gray-50 px-4 py-2 border-b font-bold text-xs text-gray-500">HISTORIAL</div>
                        {history.map((h, i) => (
                            <div key={h.id+i} className="border-b last:border-0">
                                <div onClick={() => setExpandedId(expandedId === h.id ? null : h.id)} className={`px-4 py-3 flex justify-between items-center cursor-pointer ${expandedId === h.id ? 'bg-blue-50' : ''}`}>
                                    <div><div className="font-bold text-sm text-gray-800">{h.displayDate}</div><div className="text-[10px] text-gray-400">{h.items.length} items</div></div>
                                    <div className="flex items-center gap-2"><span className="font-bold text-blue-600">${h.total.toLocaleString('es-AR')}</span>{expandedId===h.id ? <Icons.ChevronUp size={16}/> : <Icons.ChevronDown size={16}/>}</div>
                                </div>
                                {expandedId === h.id && (
                                    <div className="bg-gray-50 p-3 text-xs border-t animate-in slide-in-from-top-1 fade-in">
                                        {h.items.map((item, idx) => (
                                            <div key={idx} className="flex justify-between mb-2 border-b border-dashed pb-1 last:border-0">
                                                <div className="flex-1"><span className="font-bold text-blue-600 mr-1">{item.actualQty}x</span>{item.name}<div className="text-[10px] text-gray-500">{item.brand} • {item.category}</div></div>
                                                <div className="font-medium">${item.price.toLocaleString('es-AR')}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // RENDERIZAR
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><NiniApp /></ErrorBoundary>);
    </script>
</body>
</html>
