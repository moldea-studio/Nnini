<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nini Cloud App</title>
    
    <!-- PWA -->
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://i.imgur.com/23tlEnQ.jpeg">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk5pbmkgQ2xvdWQiLAogICJzaG9ydF9uYW1lIjogIk5pbmkiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2kuaW1ndXIuY29tLzIzdGxFblEuanBlZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvanBlZyIKICAgIH0KICBdCn0=">

    <!-- LIBRERÍAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, orderBy, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, orderBy, writeBatch, deleteDoc, getDocs };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- TUS CLAVES REALES ---
        const firebaseConfig = {
          apiKey: "AIzaSyD1XQbCn5DjBr6mSJ2LyAihW6_pRpcMdLs",
          authDomain: "nini-app-61a6a.firebaseapp.com",
          projectId: "nini-app-61a6a",
          storageBucket: "nini-app-61a6a.firebasestorage.app",
          messagingSenderId: "1019944365082",
          appId: "1:1019944365082:web:3e921a4207a846306235a3"
        };

        const SHEET_ID = "1Yz_Br2J41diPtd-PL8lLE_Q8eQex-Vf7ifkIqdEqQEQ";
        const LINK_HOJA_PRODUCTOS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_PRODUCTOS`; 
        const LINK_HOJA_HISTORIAL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_HISTORIAL`;

        const COLORS = {
            blue: '#004aad',
            red: '#e31d2b',
            bg: '#f8f9fa',
            barColor1: '#93C5FD', 
            barColor2: '#60A5FA', 
            pastelGray: '#E5E7EB',
            chartColors: ['#93C5FD', '#FCA5A5', '#86EFAC', '#FDE047', '#D8B4FE', '#F9A8D4', '#67E8F9', '#C4B5FD']
        };

        const INITIAL_PRODUCTS = [
            { id: '101', name: 'Cargando...', brand: '...', category: 'General', price: 0, plannedQty: 0, actualQty: 0 },
        ];

        // --- ICONOS INTEGRADOS ---
        const Icon = ({ path, size = 24, className = "", fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        
        const Icons = {
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Plus: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Minus: (p) => <Icon {...p} path={<path d="M5 12h14"/>} />,
            Lock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            Unlock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>} />,
            Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>} />,
            PieChart: (p) => <Icon {...p} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />,
            Database: (p) => <Icon {...p} path={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            Copy: (p) => <Icon {...p} path={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>} />,
            ChevronDown: (p) => <Icon {...p} path={<path d="m6 9 6 6 6-6"/>} />,
            ChevronUp: (p) => <Icon {...p} path={<path d="m18 15-6-6-6 6"/>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Share: (p) => <Icon {...p} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Google: (p) => <Icon {...p} fill="currentColor" path={<path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .533 5.333.533 12S5.867 24 12.48 24c3.44 0 6.013-1.133 8.053-3.24 2.067-2.067 2.693-5.067 2.693-7.56 0-.747-.053-1.467-.147-2.147H12.48z"/>} />
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen p-6 text-center bg-gray-50">
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-red-100">
                                <Icons.AlertTriangle className="text-red-500 w-12 h-12 mx-auto mb-4" />
                                <h2 className="text-xl font-bold text-gray-800 mb-2">Algo salió mal</h2>
                                <p className="text-xs text-red-600 mb-4 font-mono bg-red-50 p-2 rounded">{this.state.error?.toString()}</p>
                                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-red-600 transition">
                                    REINICIAR APP
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- COMPONENTE PUBLICIDAD ---
        const AdBanner = () => (
            <div className="bg-white border-b border-gray-100 py-3 px-4 flex justify-center">
                <div className="w-full max-w-sm h-12 bg-gray-100 rounded border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-400">
                    ESPACIO PUBLICITARIO (ADS)
                </div>
            </div>
        );

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [fb, setFb] = useState(null);
            const [view, setView] = useState('login'); 
            const [products, setProducts] = useState(INITIAL_PRODUCTS);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [statusMsg, setStatusMsg] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [isDemoMode, setIsDemoMode] = useState(false);
            
            const [isLoggingIn, setIsLoggingIn] = useState(false);

            // Filtros UI
            const [filter, setFilter] = useState('Todos'); 
            const [brandFilter, setBrandFilter] = useState('Todas');
            const [showBrandFilter, setShowBrandFilter] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [isLocked, setIsLocked] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportContent, setExportContent] = useState('');
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            // 1. INICIAR FIREBASE
            useEffect(() => {
                const init = () => {
                    if(window.FirebaseSDK) {
                        try {
                            const { initializeApp, getAuth, getFirestore, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, signInWithPopup } = window.FirebaseSDK;
                            
                            const app = initializeApp(firebaseConfig);
                            const auth = getAuth(app);
                            const db = getFirestore(app);
                            
                            setFb({ auth, db, signInAnonymously, GoogleAuthProvider, signInWithPopup });
                            
                            onAuthStateChanged(auth, (u) => {
                                setUser(u);
                                setLoading(false);
                                if(u) setView('list');
                            });
                        } catch(e) {
                            console.error("Error Config Firebase:", e);
                            setLoading(false);
                            enableDemoMode();
                        }
                    } else {
                        setTimeout(init, 500);
                    }
                };
                init();
            }, []);

            const enableDemoMode = () => {
                setIsDemoMode(true);
                setUser({ uid: 'demo-user', isAnonymous: true });
                setLoading(false);
                setView('list');
                fetchProductsFromSheet();
            };

            // 2. ESCUCHAR DATOS (REALTIME)
            useEffect(() => {
                if(!user || !fb || isDemoMode) return;
                const { onSnapshot, collection, orderBy, query } = window.FirebaseSDK;
                const db = fb.db; // FIX: Usar la instancia DB correcta
                
                // Productos
                const prodRef = collection(db, `users/${user.uid}/products`);
                const unsubProd = onSnapshot(prodRef, (snap) => {
                    const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setProducts(items.sort((a,b) => (a.name || '').localeCompare(b.name || '')));
                }, (error) => {
                    console.warn("Error leyendo productos:", error);
                    enableDemoMode();
                });

                // Historial
                const histRef = query(collection(db, `users/${user.uid}/history`), orderBy("date", "desc"));
                const unsubHist = onSnapshot(histRef, (snap) => {
                    const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setHistory(items);
                });

                return () => { unsubProd(); unsubHist(); };
            }, [user, fb]);

            // Install Logic
            useEffect(() => {
                const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallClick = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') setDeferredPrompt(null);
                    });
                } else {
                    setShowInstallModal(true);
                }
            };

            // ACCIONES
            const handleLogin = async () => {
                if (isLoggingIn) return;
                setIsLoggingIn(true);
                try {
                    const { GoogleAuthProvider } = window.FirebaseSDK;
                    const provider = new GoogleAuthProvider();
                    await fb.signInWithPopup(fb.auth, provider);
                } catch(e) {
                    console.error("Error login:", e);
                    alert("No se pudo conectar con Google (Bloqueo del navegador o dominio no autorizado). Se activará el Modo Prueba Local.");
                    enableDemoMode();
                } finally {
                    setIsLoggingIn(false);
                }
            };
            
            const handleAnonymousLogin = async () => {
                if (isLoggingIn) return;
                setIsLoggingIn(true);
                try {
                    await fb.signInAnonymously(fb.auth);
                } catch (e) {
                    console.error("Error anon:", e);
                    enableDemoMode();
                } finally {
                    setIsLoggingIn(false);
                }
            };

            const handleUpdateProduct = async (id, data) => {
                setProducts(prev => prev.map(p => p.id === id ? { ...p, ...data } : p));
                
                if (user && fb && !isDemoMode) {
                    const { doc, updateDoc } = window.FirebaseSDK;
                    const db = fb.db; // FIX: Usar instancia
                    try {
                        const ref = doc(db, `users/${user.uid}/products`, id);
                        await updateDoc(ref, data);
                    } catch(e) { console.warn("No se pudo guardar en nube", e); }
                }
            };

            const handleAddProduct = async (newItem) => {
                setProducts(prev => [newItem, ...prev]);

                if (user && fb && !isDemoMode) {
                    const { collection, addDoc } = window.FirebaseSDK;
                    const db = fb.db; // FIX: Usar instancia
                    try {
                        const ref = collection(db, `users/${user.uid}/products`);
                        await addDoc(ref, newItem);
                    } catch(e) { console.warn("No se pudo guardar en nube", e); }
                }
            };

            const handleImportSheet = async () => {
                if(!confirm("Esto importará los productos del Google Sheet a tu App. ¿Seguro?")) return;
                setStatusMsg('Importando...');
                setShowSettings(false);
                
                const cleanCSVValue = (text) => (typeof text === 'string' ? text.replace(/^"|"$/g, '').replace('$', '').trim() : "");
                const parseNumberAR = (str) => {
                    if (!str) return 0;
                    if (typeof str === 'number') return str;
                    try {
                        const strVal = String(str);
                        if (strVal.includes('.') && !strVal.includes(',')) return parseFloat(strVal) || 0;
                        return parseFloat(strVal.replace(/\./g, '').replace(',', '.')) || 0;
                    } catch (e) { return 0; }
                };

                try {
                    const res = await fetch(OLD_SHEET_URL);
                    const txt = await res.text();
                    if(txt.includes('<html')) throw new Error("Sheet privado");
                    
                    const lines = txt.split('\n').slice(1);
                    const { collection, writeBatch, doc } = window.FirebaseSDK;
                    const db = fb.db; // FIX: Usar instancia
                    
                    let batch = writeBatch(db);
                    let count = 0;
                    
                    lines.forEach(l => {
                        const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanCSVValue);
                        if(c.length < 2) return;
                        const name = c[1];
                        if(!name) return;

                        const newRef = doc(collection(db, `users/${user.uid}/products`));
                        batch.set(newRef, {
                            name,
                            brand: c[2] || 'Genérico',
                            category: c[3] || 'Varios',
                            price: parseNumberAR(c[4]),
                            plannedQty: 0,
                            actualQty: 0
                        });
                        count++;
                        if(count % 400 === 0) { batch.commit(); batch = writeBatch(db); }
                    });
                    
                    await batch.commit();
                    setStatusMsg('¡Importación exitosa!');
                    setTimeout(() => setStatusMsg(''), 3000);
                } catch(e) {
                    alert("Error: " + e.message);
                    setStatusMsg('');
                }
            };
            
            const handleCleanDB = async () => {
                if(!confirm("PELIGRO: Esto borrará todos tus productos. ¿Continuar?")) return;
                setProducts([]);
                if(!isDemoMode) {
                     const { collection, getDocs, deleteDoc, doc } = window.FirebaseSDK;
                     const db = fb.db; // FIX
                     const snap = await getDocs(collection(db, `users/${user.uid}/products`));
                     snap.forEach(d => deleteDoc(doc(db, `users/${user.uid}/products`, d.id)));
                }
                alert("Limpio.");
            };

            const cleanCSVValue = (text) => (typeof text === 'string' ? text.replace(/^"|"$/g, '').replace('$', '').trim() : "");
            const parseNumberAR = (str) => {
                if (!str) return 0;
                if (typeof str === 'number') return str;
                try {
                    const strVal = String(str);
                    if (strVal.includes('.') && !strVal.includes(',')) return parseFloat(strVal) || 0;
                    return parseFloat(strVal.replace(/\./g, '').replace(',', '.')) || 0;
                } catch (e) { return 0; }
            };

            const fetchProductsFromSheet = async () => {
                try {
                    const res = await fetch(LINK_HOJA_PRODUCTOS_URL);
                    const txt = await res.text();
                    if(txt.includes('<html')) throw new Error("Privado");
                    const lines = txt.split('\n').slice(1);
                    const newProds = [];
                    lines.forEach((l, i) => {
                        const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanCSVValue);
                        if(c.length < 2) return;
                        const id = c[0] || `r${i}`;
                        const name = c[1];
                        if(!name || name === 'Sin Nombre') return;
                        
                        const existing = products.find(p => p.id === id || p.name === name);
                        newProds.push({
                            id: id,
                            name: name, 
                            brand: c[2] || 'Generico', category: c[3] || 'Varios', 
                            price: parseNumberAR(c[4]),
                            plannedQty: existing ? existing.plannedQty : 0,
                            actualQty: existing ? existing.actualQty : 0
                        });
                    });
                    if(newProds.length > 0) {
                        setProducts(newProds);
                        setStatusMsg('¡Importado del Sheet!');
                        setTimeout(() => setStatusMsg(''), 3000);
                        
                        if (!isDemoMode && fb && user) {
                            const { collection, writeBatch, doc } = window.FirebaseSDK;
                            const db = fb.db; // FIX
                            const batch = writeBatch(db);
                            newProds.forEach(p => {
                                const ref = doc(collection(db, `users/${user.uid}/products`));
                                batch.set(ref, p);
                            });
                            batch.commit().catch(console.error);
                        }
                    }
                } catch(e) { console.warn("Sheet offline", e); setStatusMsg('Error leyendo Sheet'); }
            };

            const handleFinishPurchase = async () => {
                const boughtItems = products.filter(p => p.actualQty > 0);
                if (boughtItems.length === 0) return alert("El carrito está vacío");

                if (!confirm("¿Guardar compra y limpiar carrito?")) return;
                
                const total = boughtItems.reduce((acc, p) => acc + (p.price * p.actualQty), 0);
                const historyItem = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    total: total,
                    items: boughtItems.map(p => ({ 
                        name: p.name, brand: p.brand, category: p.category, price: p.price, actualQty: p.actualQty 
                    }))
                };

                setHistory(prev => [historyItem, ...prev]);
                
                if (user && fb && !isDemoMode) {
                    const { collection, addDoc, doc, updateDoc } = window.FirebaseSDK;
                    const db = fb.db; // FIX
                    await addDoc(collection(db, `users/${user.uid}/history`), historyItem);
                    boughtItems.forEach(p => {
                        const ref = doc(db, `users/${user.uid}/products`, p.id);
                        updateDoc(ref, { actualQty: 0 });
                    });
                }

                setProducts(prev => prev.map(p => ({...p, actualQty: 0})));
                
                setView('history');
            };

            const handleQty = (id, d, field) => {
                if(field === 'plannedQty' && isLocked) return;
                setProducts(prev => prev.map(p => p.id === id ? { ...p, [field]: Math.max(0, p[field] + d) } : p));
                if (user && fb && !isDemoMode) {
                    const p = products.find(p => p.id === id);
                    if(p) handleUpdateProduct(id, { [field]: Math.max(0, (p[field]||0) + d) });
                }
            };

            const handleAddItem = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const newItem = {
                    name: fd.get('name'),
                    brand: fd.get('brand') || 'Genérico',
                    category: fd.get('category'),
                    price: parseNumberAR(fd.get('price')),
                    plannedQty: 0,
                    actualQty: 1
                };
                handleAddProduct(newItem);
                setShowAddModal(false);
                setStatusMsg('Agregado');
                setTimeout(()=>setStatusMsg(''), 2000);
            };

            const copyToClip = () => {
                document.getElementById('exportarea').select();
                document.execCommand('copy');
                alert("Copiado.");
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-blue-600 text-white font-bold animate-pulse">Cargando Nini Cloud...</div>;

            if (!user) return (
                <div className="h-screen bg-gradient-to-b from-blue-900 to-blue-700 flex flex-col items-center justify-center p-8 text-white text-center">
                    <img src="https://i.imgur.com/23tlEnQ.jpeg" className="w-40 rounded-3xl shadow-xl mb-8"/>
                    <h1 className="text-3xl font-black mb-2">Mi Nini App</h1>
                    <p className="text-blue-200 mb-8">Tu lista de compras en la nube.</p>
                    
                    <div className="w-full max-w-sm space-y-3">
                        <button 
                            onClick={handleLogin} 
                            disabled={isLoggingIn}
                            className={`bg-white text-gray-800 w-full py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 hover:bg-gray-100 transition-colors ${isLoggingIn ? 'opacity-70 cursor-wait' : ''}`}
                        >
                            <Icons.Google size={20} /> {isLoggingIn ? 'Iniciando...' : 'Continuar con Google'}
                        </button>
                        <button 
                            onClick={handleAnonymousLogin} 
                            disabled={isLoggingIn}
                            className="text-blue-300 text-sm hover:text-white underline mt-4 block"
                        >
                            Entrar como invitado (Sin guardar)
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 pb-20 font-sans flex flex-col">
                    <div className="sticky top-0 z-50 bg-white shadow-md">
                         <div className="flex justify-between items-center px-4 py-2 bg-white">
                            <img src="https://i.imgur.com/23tlEnQ.jpeg" className="h-12 w-auto object-contain"/>
                            
                            <div className="flex gap-2 items-center">
                                {view === 'list' && (
                                   <TotalsHeader products={products} onSave={handleFinishPurchase} onInstall={handleInstallClick} />
                                )}
                                {view === 'history' && (
                                    <div className="text-xs font-bold text-green-600 flex items-center gap-1 bg-green-50 px-3 py-1.5 rounded-full border border-green-100">
                                        <Icons.Database size={14}/> En Línea
                                    </div>
                                )}
                                <button onClick={() => setShowSettings(true)} className="p-2 text-gray-400 hover:text-gray-600"><Icons.Settings size={20}/></button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto">
                        {view === 'list' ? (
                            <ListView 
                                products={products} 
                                onUpdate={handleUpdateProduct} 
                                onAdd={handleAddProduct}
                                onClear={() => products.forEach(p => p.actualQty > 0 && handleUpdateProduct(p.id, { actualQty: 0 }))}
                                filter={filter} setFilter={setFilter} 
                                brandFilter={brandFilter} setBrandFilter={setBrandFilter} showBrandFilter={showBrandFilter} setShowBrandFilter={setShowBrandFilter}
                                searchTerm={searchTerm} setSearchTerm={setSearchTerm}
                                isLocked={isLocked} setIsLocked={setIsLocked}
                                showAdd={showAddModal} setShowAdd={setShowAddModal}
                                handleQty={handleQty} 
                            />
                        ) : (
                            <HistoryView history={history} />
                        )}
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-5">
                                <div className="flex justify-between mb-4"><h3 className="font-bold">Configuración</h3><button onClick={()=>setShowSettings(false)}><Icons.X/></button></div>
                                
                                <div className="space-y-3">
                                    <div className="bg-blue-50 p-3 rounded text-xs text-blue-800 break-all">
                                        ID: {user.uid ? user.uid.slice(0,8) + '...' : 'Invitado'}
                                    </div>
                                    
                                    <button onClick={handleImportSheet} className="w-full py-3 bg-green-600 text-white rounded font-bold flex items-center justify-center gap-2">
                                        <Icons.Download size={18}/> Importar desde Sheet
                                    </button>
                                    
                                    <button onClick={handleCleanDB} className="w-full py-3 border border-red-200 text-red-600 rounded font-bold flex items-center justify-center gap-2 hover:bg-red-50">
                                        <Icons.Trash2 size={18}/> Borrar Base de Datos
                                    </button>

                                    {!isDemoMode && (
                                        <button onClick={async () => { await fb.signOut(fb.auth); setShowSettings(false); }} className="w-full py-3 border border-gray-300 text-gray-600 rounded font-bold flex items-center justify-center gap-2">
                                            <Icons.LogOut size={18}/> Cerrar Sesión
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showInstallModal && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 p-6 animate-fade-in" onClick={() => setShowInstallModal(false)}>
                            <div className="bg-white rounded-xl p-6 max-w-sm text-center shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowInstallModal(false)} className="absolute top-2 right-2 text-gray-400"><Icons.X size={20}/></button>
                                <h3 className="text-lg font-bold text-gray-800 mb-2">Instalar Nini App</h3>
                                <p className="text-sm text-gray-600 mb-4">Para instalar esta web como una App en tu iPhone:</p>
                                <div className="space-y-3 text-sm text-left bg-gray-50 p-4 rounded-lg">
                                    <div className="flex items-center gap-3"><Icons.Share className="text-blue-500"/> <span>1. Toca el botón <b>Compartir</b> abajo.</span></div>
                                    <div className="flex items-center gap-3"><Icons.Plus className="text-gray-600 border border-gray-400 rounded p-0.5"/> <span>2. Elige <b>"Agregar a Inicio"</b>.</span></div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 w-full flex justify-around items-center pb-safe z-50 h-16 shadow-lg" style={{ backgroundColor: COLORS.blue }}>
                        <button onClick={() => setView('list')} className={`flex flex-col items-center justify-center w-full h-full ${view === 'list' ? 'text-white' : 'text-white/50'}`}><Icons.List size={24} strokeWidth={2.5} /><span className="text-[10px] font-bold mt-1">Lista</span></button>
                        <div className="w-px h-8 bg-white/20"></div>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center justify-center w-full h-full ${view === 'history' ? 'text-white' : 'text-white/50'}`}><Icons.PieChart size={24} strokeWidth={2.5} /><span className="text-[10px] font-bold mt-1">Historial</span></button>
                    </div>

                    {statusMsg && <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-black/80 text-white text-xs px-4 py-2 rounded-full shadow-lg z-50">{statusMsg}</div>}
                </div>
            );
        }

        // --- SUBCOMPONENTES ---

        const TotalsHeader = ({ products, onSave, onInstall }) => {
            const totalBudget = products.reduce((acc, p) => acc + (p.price * (p.plannedQty || 0)), 0);
            const totalSpent = products.reduce((acc, p) => acc + (p.price * (p.actualQty || 0)), 0);
            
            return (
                <div className="flex items-center gap-2">
                   <button onClick={onInstall} className="bg-gray-100 text-blue-600 text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1 hover:bg-gray-200 border border-gray-200" title="Instalar App">
                       <Icons.Download size={14}/> <span>App</span>
                   </button>

                   <div className="flex items-center bg-gray-50 rounded-lg p-1 px-3 border border-gray-200 shadow-sm">
                       <div className="flex flex-col items-end mr-3">
                           <span className="text-[9px] text-gray-500 font-bold uppercase tracking-wider">Plan</span>
                           <span className="text-sm font-medium text-gray-700">${totalBudget.toLocaleString('es-AR')}</span>
                       </div>
                       <div className="w-px h-6 bg-gray-300"></div>
                       <div className="flex flex-col items-end ml-3">
                           <span className="text-[10px] text-blue-600 font-black uppercase tracking-wider">Carrito</span>
                           <span className="text-2xl font-black text-blue-900 leading-none">${totalSpent.toLocaleString('es-AR')}</span>
                       </div>
                   </div>
                   <button onClick={onSave} className="bg-blue-600 text-white p-2 rounded-full shadow-lg active:scale-95 hover:bg-blue-700 transition-all">
                       <Icons.Save size={18} />
                   </button>
                </div>
            );
        };

        const ListView = ({ products, onUpdate, onAdd, onClear, filter, setFilter, brandFilter, setBrandFilter, showBrandFilter, setShowBrandFilter, searchTerm, setSearchTerm, isLocked, setIsLocked, showAdd, setShowAdd, handleQty }) => {
            const cats = ['Todos', ...new Set(products.map(p => p.category || 'Varios'))].sort();
            const brands = ['Todas', ...new Set(products.filter(p => filter === 'Todos' || p.category === filter).map(p => p.brand || 'Genérico'))].sort();
            const filtered = products.filter(p => {
                const matchCat = filter === 'Todos' || p.category === filter;
                const matchBrand = brandFilter === 'Todas' || p.brand === brandFilter;
                const matchSearch = (p.name || '').toLowerCase().includes(searchTerm.toLowerCase());
                return matchCat && matchBrand && matchSearch;
            });

            return (
                <div>
                    <div className="bg-white p-3 border-b flex flex-col gap-3">
                        <AdBanner />
                        <div className="flex gap-2">
                             <button onClick={() => setIsLocked(!isLocked)} className={`w-10 h-10 flex items-center justify-center rounded-lg border ${isLocked ? 'bg-orange-50 border-orange-200 text-orange-600' : 'bg-gray-50 text-gray-500'}`}><Icon name={isLocked ? "Lock" : "Unlock"} size={18} /></button>
                             <div className="relative flex-1 flex gap-2">
                                <div className="relative flex-1"><span className="absolute left-3 top-2 text-gray-400"><Icons.Search size={16}/></span><input className="w-full h-10 pl-9 pr-3 rounded-lg border bg-gray-50 focus:bg-white focus:border-blue-500 outline-none text-sm" placeholder="Buscar..." onChange={e=>setSearchTerm(e.target.value)}/></div>
                                <button onClick={()=>setShowAdd(true)} className="bg-blue-600 text-white w-10 rounded flex items-center justify-center shadow"><Icons.Plus/></button>
                             </div>
                             <button onClick={() => setShowBrandFilter(!showBrandFilter)} className={`w-10 h-10 rounded-lg border flex items-center justify-center ${showBrandFilter ? 'bg-blue-100 text-blue-700' : 'bg-white text-gray-500'}`}><Icons.Filter size={18}/></button>
                             <button onClick={onClear} className="w-10 h-10 text-gray-400 hover:text-red-500 flex items-center justify-center"><Icons.Trash2 size={18}/></button>
                        </div>
                        {showBrandFilter && <div className="px-3 py-2 bg-blue-50 rounded border border-blue-100"><div className="text-[10px] font-bold text-blue-800 mb-1 uppercase">Marca</div><select value={brandFilter} onChange={e => setBrandFilter(e.target.value)} className="w-full p-2 text-sm border rounded"><option value="Todas">Todas</option>{brands.map(b => <option key={b} value={b}>{b}</option>)}</select></div>}
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">{cats.map(c => (<button key={c} onClick={() => setFilter(c)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filter === c ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'}`}>{c}</button>))}</div>
                        <div className="flex text-[10px] text-gray-400 font-bold px-3 py-1 bg-gray-50 border-b uppercase tracking-wider shadow-sm"><div className="flex-1">Producto</div><div className="w-16 text-center">Plan</div><div className="w-28 text-center">Carrito</div></div>
                    </div>

                    <div className="pb-4">
                        {filtered.map(p => (
                            <div key={p.id} className={`flex items-center px-4 py-4 border-b transition-colors ${p.actualQty > 0 ? 'bg-green-50' : 'bg-white'}`}>
                                <div className="flex-1 min-w-0 pr-2">
                                    <div className="font-bold text-gray-800 text-lg truncate">{p.name}</div>
                                    <div className="text-xs text-gray-500 truncate">{p.brand} • {p.category}</div>
                                    <div className="flex items-center mt-1"><span className="text-sm text-gray-400 mr-1">$</span><input type="number" className="font-bold text-gray-700 w-20 bg-transparent border-b border-dashed outline-none" value={p.price} onChange={e=>onUpdate(p.id, {price: Number(e.target.value)})} /></div>
                                </div>
                                <div className={`w-16 flex items-center justify-center border-x border-gray-100 px-1 ${isLocked ? 'opacity-40 pointer-events-none' : ''}`}>
                                    <button onClick={() => handleQty(p.id, -1, 'plannedQty')} className="px-1 text-gray-400"><Icons.Minus size={12}/></button>
                                    <span className="font-bold text-gray-600 w-6 text-center text-lg">{p.plannedQty||0}</span>
                                    <button onClick={() => handleQty(p.id, 1, 'plannedQty')} className="px-1 text-gray-400"><Icons.Plus size={12}/></button>
                                </div>
                                <div className="w-28 flex items-center justify-between pl-3">
                                    <button onClick={() => handleQty(p.id, -1, 'actualQty')} className="w-10 h-10 bg-white border rounded shadow-sm flex items-center justify-center text-gray-600"><Icons.Minus/></button>
                                    <span className={`text-xl font-bold ${p.actualQty >= p.plannedQty && p.plannedQty > 0 ? 'text-green-600' : 'text-blue-900'}`}>{p.actualQty||0}</span>
                                    <button onClick={() => handleQty(p.id, 1, 'actualQty')} className="w-10 h-10 bg-blue-600 text-white rounded shadow-md flex items-center justify-center active:scale-95"><Icons.Plus/></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {showAdd && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                            <form onSubmit={e => {
                                e.preventDefault(); const fd = new FormData(e.target);
                                onAdd({ name: fd.get('name'), brand: fd.get('brand')||'Genérico', category: 'Varios', price: Number(fd.get('price')), plannedQty: 0, actualQty: 1 });
                                setShowAdd(false);
                            }} className="bg-white p-5 rounded-xl w-full max-w-xs shadow-2xl">
                                <h3 className="font-bold text-lg mb-4">Nuevo Producto</h3>
                                <input name="name" className="w-full border p-2 mb-2 rounded" placeholder="Nombre" required autoFocus/>
                                <input name="brand" className="w-full border p-2 mb-2 rounded" placeholder="Marca"/>
                                <input name="price" type="number" className="w-full border p-2 mb-4 rounded" placeholder="Precio"/>
                                <div className="flex gap-2"><button type="button" onClick={()=>setShowAdd(false)} className="flex-1 py-2 text-gray-500">Cancelar</button><button type="submit" className="flex-1 py-2 bg-blue-600 text-white rounded font-bold">Agregar</button></div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = ({ history }) => {
            const [filterDate, setFilterDate] = useState('all');
            const [expandedId, setExpandedId] = useState(null);

            const availableMonths = useMemo(() => {
                const unique = new Set();
                history.forEach(h => {
                    const d = new Date(h.date);
                    if(!isNaN(d)) unique.add(JSON.stringify({ value: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`, label: d.toLocaleString('es-AR', { month: 'long', year: 'numeric' }) }));
                });
                return Array.from(unique).map(s => JSON.parse(s)).sort((a,b) => b.value.localeCompare(a.value));
            }, [history]);

            const pieData = useMemo(() => {
                const source = filterDate === 'all' ? history : history.filter(h => h.date.startsWith(filterDate));
                const catMap = {}; let total = 0;
                source.forEach(h => {
                    if(h.items) h.items.forEach(i => {
                        const sub = (i.actualQty||0)*(i.price||0);
                        catMap[i.category] = (catMap[i.category] || 0) + sub;
                        total += sub;
                    });
                });
                return Object.entries(catMap).map(([k,v]) => ({ name: k, value: v, percent: total ? (v/total)*100 : 0 })).sort((a,b)=>b.value-a.value);
            }, [history, filterDate]);

            const monthlyData = useMemo(() => {
                const months = Array.from({length: 12}, (_, i) => ({ label: new Date(2024, i, 1).toLocaleString('es-AR', { month: 'short' }).toUpperCase(), total: 0 }));
                history.forEach(h => { const d = new Date(h.date); if(!isNaN(d)) months[d.getMonth()].total += h.total; });
                return months;
            }, [history]);

            const maxMonthly = Math.max(...monthlyData.map(d => d.total), 1);
            const totalAnnual = monthlyData.reduce((acc, curr) => acc + curr.total, 0);
            const pieGradient = pieData.length > 0 ? pieData.reduce((acc, cat, idx) => {
                const prev = pieData.slice(0, idx).reduce((p, c) => p + c.percent, 0);
                const color = COLORS.chartColors[idx % COLORS.chartColors.length];
                return `${acc}, ${color} ${prev}% ${prev + cat.percent}%`;
            }, '').slice(2) : '#ddd 0% 100%';

            return (
                <div className="p-4 space-y-6 pb-24">
                    {/* Torta */}
                    <div className="bg-white rounded-xl shadow-sm border p-4">
                        <div className="flex justify-between items-start mb-4">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2"><Icons.PieChart size={18} className="text-blue-500"/> Gasto por Rubro</h3>
                            <div className="relative">
                                <select value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="appearance-none bg-gray-100 text-gray-700 text-xs font-bold py-1 pl-3 pr-8 rounded-lg border focus:outline-none"><option value="all">Todo el Año</option>{availableMonths.map(m => (<option key={m.value} value={m.value}>{m.label}</option>))}</select><Icons.ChevronDown size={14} className="absolute right-2 top-1.5 text-gray-500 pointer-events-none" />
                            </div>
                        </div>
                        <div className="flex flex-row items-center gap-4"><div className="w-32 h-32 rounded-full relative shadow-inner flex-shrink-0" style={{ background: `conic-gradient(${pieGradient})` }}><div className="absolute inset-8 bg-white rounded-full flex items-center justify-center flex-col"><span className="text-[9px] text-gray-400 font-bold uppercase">TOTAL</span><span className="text-xs font-bold text-gray-700">${Math.round(pieData.reduce((a,b)=>a+b.value,0)/1000)}k</span></div></div><div className="flex-1 space-y-1">{pieData.slice(0,5).map((cat, idx) => (<div key={idx} className="flex justify-between items-center text-xs"><div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.chartColors[idx % COLORS.chartColors.length] }}></div><span className="text-gray-600 truncate max-w-[80px]">{cat.name}</span></div><span className="font-bold">{Math.round(cat.percent)}%</span></div>))}</div></div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border p-4">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700">Evolución Anual</h3><span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Total: ${totalAnnual.toLocaleString('es-AR')}</span></div>
                        <div className="flex items-end gap-1 h-32 border-b pb-2">{monthlyData.map((d, i) => (<div key={i} className="flex-1 flex flex-col items-center gap-1 h-full justify-end group"><div className="w-full relative flex items-end justify-center h-full"><div className="w-full rounded-t-sm transition-all relative" style={{ height: d.total > 0 ? `${(d.total/maxMonthly)*100}%` : '4px', backgroundColor: d.total > 0 ? (i%2===0 ? COLORS.barColor1 : COLORS.barColor2) : COLORS.pastelGray }}>{d.total > 0 && <div className="opacity-0 group-hover:opacity-100 absolute -top-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[9px] px-1 rounded pointer-events-none transition-opacity z-10 whitespace-nowrap">${d.total.toLocaleString('es-AR')}</div>}</div></div><span className={`text-[8px] font-bold uppercase ${d.total > 0 ? 'text-gray-700' : 'text-gray-300'}`}>{d.label}</span></div>))}</div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="bg-gray-50 px-4 py-2 border-b font-bold text-xs text-gray-500">HISTORIAL</div>
                        {history.map((h, i) => (
                            <div key={h.id} className="border-b last:border-0">
                                <div onClick={() => setExpandedId(expandedId === h.id ? null : h.id)} className="px-4 py-3 flex justify-between items-center bg-white hover:bg-gray-50 cursor-pointer">
                                    <div><div className="font-bold text-sm">{new Date(h.date).toLocaleDateString('es-AR')}</div><div className="text-xs text-gray-400">{h.items?.length || 0} items</div></div>
                                    <div className="flex items-center gap-2"><span className="font-bold text-blue-600">${h.total.toLocaleString('es-AR')}</span><Icons.ChevronDown size={16}/></div>
                                </div>
                                {expandedId === h.id && (<div className="bg-gray-50 p-3 text-xs border-t">{h.items?.map((item, idx) => (<div key={idx} className="flex justify-between mb-1 border-b border-dashed last:border-0 pb-1"><span>{item.actualQty}x {item.name}</span><span>${item.price}</span></div>))}</div>)}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>


