import React, { useState, useEffect, useMemo, Component } from 'react';
import { ShoppingCart, Trash2, Plus, Minus, Search, Lock, Unlock, Filter, Copy, Save, PieChart, List, Upload, Settings, RefreshCw, X, Check, ExternalLink, Database, AlertTriangle, ChevronDown, ChevronUp } from 'lucide-react';

// --- CONFIGURACIÓN ---
const SHEET_ID = "1Yz_Br2J41diPtd-PL8lLE_Q8eQex-Vf7ifkIqdEqQEQ";
const LINK_HOJA_PRODUCTOS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_PRODUCTOS`; 
const LINK_HOJA_HISTORIAL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_HISTORIAL`;

// --- CONSTANTES ---
const COLORS = {
  blue: '#004aad',
  red: '#e31d2b',
  bg: '#f8f9fa',
  barColor1: '#93C5FD', 
  barColor2: '#60A5FA', 
  pastelGray: '#E5E7EB',
  chartColors: ['#93C5FD', '#FCA5A5', '#86EFAC', '#FDE047', '#D8B4FE', '#F9A8D4', '#67E8F9', '#C4B5FD']
};

const INITIAL_PRODUCTS = [
  { id: 'init_1', name: 'Cargando lista...', brand: '...', category: 'General', price: 0, plannedQty: 0, actualQty: 0 },
];

// --- ERROR BOUNDARY (ESCUDO DE PROTECCIÓN) ---
class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error("Error capturado por el escudo:", error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="p-6 text-center">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <h2 className="text-red-700 font-bold mb-2">¡Ups! Algo salió mal.</h2>
            <p className="text-xs text-red-600 font-mono mb-4">{this.state.error?.toString()}</p>
            <button 
                onClick={() => {
                    localStorage.removeItem('nini_current_list');
                    window.location.reload();
                }}
                className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg active:scale-95"
            >
                REINICIAR APP DE CERO
            </button>
          </div>
          <p className="text-xs text-gray-500">Se han borrado los datos temporales para intentar recuperar el sistema.</p>
        </div>
      );
    }
    return this.props.children;
  }
}

// --- APP PRINCIPAL ---
function NiniAppContent() {
  const [activeTab, setActiveTab] = useState('list'); 
  
  // 1. Inicializar con datos seguros SIEMPRE
  const [products, setProducts] = useState(INITIAL_PRODUCTS);
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(false);
  const [statusMsg, setStatusMsg] = useState('');
  
  // UI States
  const [filter, setFilter] = useState('Todos'); 
  const [brandFilter, setBrandFilter] = useState('Todas');
  const [showBrandFilter, setShowBrandFilter] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [isLocked, setIsLocked] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportContent, setExportContent] = useState('');

  // 2. Cargar LocalStorage y Sheet DESPUÉS del primer render (Efecto Seguro)
  useEffect(() => {
      // Cargar LocalStorage
      try {
          const saved = localStorage.getItem('nini_current_list');
          if (saved) {
              const parsed = JSON.parse(saved);
              if (Array.isArray(parsed) && parsed.length > 0) {
                  setProducts(parsed);
              }
          }
      } catch (e) { console.warn("Error leyendo memoria, usando default"); }

      // Cargar Sheet
      fetchProductsFromSheet(LINK_HOJA_PRODUCTOS_URL);
  }, []);

  useEffect(() => {
      if (activeTab === 'history') {
          fetchHistoryFromSheet(LINK_HOJA_HISTORIAL_URL);
      }
  }, [activeTab]);

  // Guardado automático
  useEffect(() => {
      if (products !== INITIAL_PRODUCTS && Array.isArray(products)) {
          localStorage.setItem('nini_current_list', JSON.stringify(products));
      }
  }, [products]);

  // --- PARSERS ---
  const cleanCSVValue = (text) => {
      if (typeof text !== 'string') return "";
      return text.replace(/^"|"$/g, '').replace('$', '').trim();
  };

  const parseNumberAR = (str) => {
      if (!str) return 0;
      if (typeof str === 'number') return str;
      try {
          const strVal = String(str);
          if (strVal.includes('.') && !strVal.includes(',')) return parseFloat(strVal) || 0;
          const clean = strVal.replace(/\./g, '').replace(',', '.');
          const num = parseFloat(clean);
          return isNaN(num) ? 0 : num;
      } catch (e) { return 0; }
  };

  // --- FETCHERS ---
  const fetchProductsFromSheet = async (url) => {
      setStatusMsg('Actualizando...');
      try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("Error red");
          const txt = await res.text();
          if (txt.includes('<html')) throw new Error("Privado");

          const lines = txt.split('\n');
          const dataLines = lines.slice(1);
          const newProds = [];

          dataLines.forEach((line, idx) => {
              const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanCSVValue);
              if (cols.length < 2) return;
              
              const id = cols[0] || `r${idx}`;
              const name = cols[1];
              if (!name || name === 'Sin Nombre') return;

              // Recuperar cantidades locales
              const existing = products.find(p => p.id === id || p.name === name);
              
              newProds.push({
                  id: id,
                  name: name,
                  brand: cols[2] || 'Generico',
                  category: cols[3] || 'Varios',
                  price: parseNumberAR(cols[4]),
                  plannedQty: existing ? (existing.plannedQty || 0) : 0,
                  actualQty: existing ? (existing.actualQty || 0) : 0
              });
          });

          if (newProds.length > 0) {
              setProducts(prev => {
                  // Fusionar inteligente para no perder cantidades si el fetch tarda
                  const merged = newProds.map(np => {
                      const local = prev.find(p => p.id === np.id || p.name === np.name);
                      if (local) {
                          return { ...np, plannedQty: local.plannedQty, actualQty: local.actualQty };
                      }
                      return np;
                  });
                  return merged;
              });
              setStatusMsg('¡Listo!');
              setTimeout(() => setStatusMsg(''), 2000);
          }
      } catch (e) {
          console.warn("Offline:", e);
          setStatusMsg('');
      }
  };

  const fetchHistoryFromSheet = async (url) => {
      setLoading(true);
      try {
          const res = await fetch(url);
          const txt = await res.text();
          if (txt.includes('<html')) throw new Error("Privado");

          const lines = txt.split('\n');
          const headerIdx = lines.findIndex(l => l.toLowerCase().includes('fecha'));
          const dataLines = headerIdx !== -1 ? lines.slice(headerIdx + 1) : lines;
          
          const groups = {};

          dataLines.forEach(line => {
              const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cleanCSVValue);
              if (cols.length < 5) return;

              const rawDate = cols[0];
              const name = cols[1];
              if (!rawDate || !name) return;

              const brand = cols[2] || '-';
              const category = cols[3] || 'Varios';
              const qty = parseNumberAR(cols[4]);
              const price = parseNumberAR(cols[5]);
              
              if (!groups[rawDate]) groups[rawDate] = { total: 0, items: [] };
              
              const subtotal = qty * price;
              groups[rawDate].items.push({ name, brand, category, actualQty: qty, price });
              groups[rawDate].total += subtotal;
          });

          const parsedHistory = Object.keys(groups).map(dateStr => {
              let isoDate = new Date().toISOString(); 
              try {
                  if (dateStr.includes('/')) {
                      const parts = dateStr.split('/');
                      if(parts.length >= 3) {
                          const [d, m, y] = parts;
                          const fullYear = y.length === 2 ? `20${y}` : y;
                          const mm = m.padStart(2, '0');
                          const dd = d.padStart(2, '0');
                          // ISO String for sorting
                          const dateObj = new Date(`${fullYear}-${mm}-${dd}T12:00:00`);
                          if (!isNaN(dateObj.getTime())) isoDate = dateObj.toISOString();
                      }
                  } else if (dateStr.includes('-')) {
                      const dateObj = new Date(dateStr);
                      if (!isNaN(dateObj.getTime())) isoDate = dateObj.toISOString();
                  }
              } catch (e) {}

              return {
                  id: dateStr + Math.random(),
                  date: isoDate,
                  displayDate: dateStr,
                  total: groups[dateStr].total,
                  items: groups[dateStr].items
              };
          }).sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());

          setHistory(parsedHistory);
      } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  // --- HANDLERS ---
  const safeProducts = Array.isArray(products) ? products : INITIAL_PRODUCTS;

  const dynamicCategories = useMemo(() => {
      const cats = new Set(safeProducts.map(p => p.category || 'Varios'));
      return ['Todos', ...Array.from(cats).sort()];
  }, [safeProducts]);

  const filteredProducts = safeProducts.filter(p => {
      const matchesCat = filter === 'Todos' || p.category === filter;
      const matchesSearch = (p.name || '').toLowerCase().includes(searchTerm.toLowerCase());
      return matchesCat && matchesSearch;
  });

  const availableBrands = useMemo(() => {
      const brands = new Set(safeProducts.filter(p => filter === 'Todos' || p.category === filter).map(p => p.brand || 'Genérico'));
      return Array.from(brands).sort();
  }, [safeProducts, filter]);

  const totalBudget = safeProducts.reduce((acc, p) => acc + (p.price * p.plannedQty), 0);
  const totalSpent = safeProducts.reduce((acc, p) => acc + (p.price * p.actualQty), 0);

  const handleQty = (id, delta, field) => {
      if (field === 'plannedQty' && isLocked) return;
      setProducts(prev => prev.map(p => p.id === id ? { ...p, [field]: Math.max(0, p[field] + delta) } : p));
  };

  const handleFinish = () => {
      const items = safeProducts.filter(p => p.actualQty > 0);
      if (items.length === 0) return alert("Carrito vacío");
      const date = new Date().toLocaleDateString('es-AR');
      let txt = "";
      items.forEach(p => {
          txt += `${date}\t${p.name}\t${p.brand}\t${p.category}\t${p.actualQty}\t${p.price}\t${p.actualQty * p.price}\n`;
      });
      setExportContent(txt);
      setShowExportModal(true);
  };

  const copyToClip = () => {
      const el = document.getElementById('exportarea');
      if (el) {
          el.select();
          document.execCommand('copy');
          alert("¡Copiado! Pega en la primera celda vacía de la Columna A del Sheet.");
      }
  };

  return (
    <div className="min-h-screen pb-20 font-sans text-gray-800 flex flex-col" style={{ backgroundColor: COLORS.bg }}>
        {/* HEADER */}
        <div className="sticky top-0 z-40 bg-white shadow-md border-b border-gray-200">
            <div className="flex justify-between items-center px-4 py-3" style={{ background: `linear-gradient(135deg, ${COLORS.blue} 0%, #002a60 100%)` }}>
                <div className="flex flex-col leading-none select-none">
                    <div className="font-black text-2xl tracking-tighter flex items-baseline">
                        <span className="text-white">n</span><span style={{color: COLORS.red}}>i</span>
                        <span className="text-white">n</span><span style={{color: COLORS.red}}>i</span>
                    </div>
                    <span className="text-[9px] font-bold uppercase tracking-widest -mt-1 text-blue-200">mayorista</span>
                </div>
                
                {activeTab === 'list' && (
                    <div className="flex gap-4 text-right items-center text-white">
                        <div><div className="text-[9px] text-blue-200 font-bold uppercase">Plan</div><div className="text-sm font-semibold">${totalBudget}</div></div>
                        <div><div className="text-[9px] text-blue-200 font-bold uppercase">Carrito</div><div className="text-lg font-bold text-white">${totalSpent}</div></div>
                        <button onClick={handleFinish} className="ml-1 bg-white text-blue-800 p-2 rounded-full shadow-lg active:scale-95 hover:bg-gray-100"><Save size={18}/></button>
                    </div>
                )}
                {activeTab === 'history' && <div className="text-xs font-bold text-blue-200 flex items-center gap-1 bg-white/10 px-2 py-1 rounded"><Database size={12}/> Conectado</div>}
            </div>

            {/* BARRA FILTROS */}
            {activeTab === 'list' && (
                <div className="flex flex-col bg-gray-50 border-t border-gray-100">
                    <div className="flex items-center gap-2 px-3 py-2">
                        <button onClick={() => setIsLocked(!isLocked)} className={`flex items-center justify-center w-8 h-8 rounded text-xs font-bold ${isLocked ? 'bg-orange-100 text-orange-700' : 'bg-white text-green-700 border'}`}>{isLocked ? <Lock size={16} /> : <Unlock size={16} />}</button>
                        <div className="relative flex-1"><Search className="absolute left-2 top-2 h-4 w-4 text-gray-400" /><input type="text" placeholder="Buscar..." className="w-full pl-8 pr-2 py-1.5 text-sm bg-white border rounded focus:outline-none" onChange={e => setSearchTerm(e.target.value)} /></div>
                        <button onClick={() => setShowBrandFilter(!showBrandFilter)} className={`flex items-center justify-center w-8 h-8 rounded border transition-colors ${showBrandFilter ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-white text-gray-500'}`}><Filter size={16} /></button>
                        <button onClick={() => setProducts(prev => prev.map(p=>({...p, actualQty:0})))} className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500"><Trash2 size={16}/></button>
                    </div>
                    {showBrandFilter && (
                        <div className="px-3 py-2 bg-blue-50 animate-in slide-in-from-top-2 border-b">
                            <div className="text-[10px] font-bold text-blue-800 mb-1 uppercase tracking-wider">Filtrar por Marca</div>
                            <select value={brandFilter} onChange={(e) => setBrandFilter(e.target.value)} className="w-full p-2 text-sm border rounded bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="Todas">Todas las marcas</option>
                                {availableBrands.map(b => <option key={b} value={b}>{b}</option>)}
                            </select>
                        </div>
                    )}
                    <div className="overflow-x-auto whitespace-nowrap px-3 py-1 bg-white border-b no-scrollbar">
                        {dynamicCategories.map(cat => (<button key={cat} onClick={() => setFilter(cat)} className={`text-[11px] font-bold px-3 py-1 rounded-full mr-1 transition-colors ${filter === cat ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-100'}`}>{cat}</button>))}
                    </div>
                    <div className="flex text-[10px] text-gray-400 font-bold px-3 py-1 bg-gray-50 border-b uppercase tracking-wider shadow-sm">
                        <div className="flex-1">Producto / Precio</div><div className="w-16 text-center">Plan</div><div className="w-24 text-center">Carrito</div>
                    </div>
                </div>
            )}
            {statusMsg && <div className="bg-blue-600 text-white text-[10px] py-1 px-3 text-center font-bold">{statusMsg}</div>}
        </div>

        {/* CONTENIDO */}
        <div className="flex-1 overflow-y-auto">
            {activeTab === 'list' ? (
                <div className="w-full pb-8">
                    {filteredProducts.map(p => (
                        <div key={p.id} className={`flex items-center px-3 py-2 border-b transition-colors ${p.actualQty >= p.plannedQty && p.plannedQty > 0 ? 'bg-green-50/60' : 'bg-white'}`}>
                            <div className="flex-1 min-w-0 pr-2">
                                <div className="flex flex-col"><span className="text-sm font-bold truncate">{p.name}</span><span className="text-[10px] text-gray-500 truncate font-semibold">{p.brand}</span></div>
                                <div className="flex items-center gap-1 mt-0.5"><span className="text-xs text-gray-400">$</span><input type="number" className="text-xs font-medium text-gray-600 w-16 bg-transparent border-b focus:outline-none" value={p.price} onChange={e => { const val = Number(e.target.value); setProducts(prev => prev.map(i => i.id === p.id ? { ...i, price: val } : i)); }} /></div>
                            </div>
                            <div className={`w-16 flex items-center justify-center border-x px-1 ${isLocked ? 'opacity-50' : ''}`}>
                                {!isLocked && <button onClick={() => handleQty(p.id, -1, 'plannedQty')} className="px-1 text-gray-400"><Minus size={10}/></button>}
                                <span className="text-sm font-bold w-full text-center">{p.plannedQty}</span>
                                {!isLocked && <button onClick={() => handleQty(p.id, 1, 'plannedQty')} className="px-1 text-gray-400"><Plus size={10}/></button>}
                            </div>
                            <div className="w-24 flex items-center justify-between pl-2">
                                <button onClick={() => handleQty(p.id, -1, 'actualQty')} className="w-7 h-7 flex items-center justify-center bg-white border rounded active:bg-gray-100"><Minus size={14}/></button>
                                <span className={`text-lg font-bold ${p.actualQty >= p.plannedQty && p.plannedQty > 0 ? 'text-green-600' : 'text-blue-900'}`}>{p.actualQty}</span>
                                <button onClick={() => handleQty(p.id, 1, 'actualQty')} className="w-7 h-7 flex items-center justify-center bg-blue-600 text-white rounded active:scale-95"><Plus size={14}/></button>
                            </div>
                        </div>
                    ))}
                    {filteredProducts.length === 0 && <div className="text-center py-8 text-gray-400">Sin productos. Revisa tu Sheet.</div>}
                </div>
            ) : (
                <HistoryViewSafe history={history} loading={loading} />
            )}
        </div>

        {/* MODAL EXPORTAR */}
        {showExportModal && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                <div className="bg-white rounded-xl shadow-xl w-full max-w-md flex flex-col max-h-[80vh]">
                    <div className="p-4 border-b flex justify-between"><h3 className="font-bold">Copiar al Excel</h3><button onClick={() => setShowExportModal(false)}><X size={20}/></button></div>
                    <div className="p-4 flex-1 bg-gray-50">
                        <textarea id="exportarea" readOnly value={exportContent} className="w-full h-32 p-2 text-xs border rounded mb-2" onClick={e => e.target.select()} />
                        <button onClick={copyToClip} className="w-full py-2 bg-green-600 text-white font-bold rounded">COPIAR AHORA</button>
                    </div>
                    <div className="p-4 border-t"><button onClick={() => { setProducts(prev => prev.map(p => ({...p, actualQty:0}))); setShowExportModal(false); }} className="w-full py-2 text-blue-600 font-bold border border-blue-600 rounded">Limpiar Carrito</button></div>
                </div>
            </div>
        )}

        {/* NAVBAR */}
        <div className="fixed bottom-0 w-full flex justify-around items-center pb-safe z-50 h-16 shadow-lg" style={{ backgroundColor: COLORS.blue }}>
            <button onClick={() => setActiveTab('list')} className={`flex flex-col items-center justify-center w-full h-full ${activeTab === 'list' ? 'text-white' : 'text-white/50'}`}><List size={24} strokeWidth={2.5} /><span className="text-[10px] font-bold mt-1">Lista</span></button>
            <div className="w-px h-8 bg-white/20"></div>
            <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center justify-center w-full h-full ${activeTab === 'history' ? 'text-white' : 'text-white/50'}`}><PieChart size={24} strokeWidth={2.5} /><span className="text-[10px] font-bold mt-1">Historial</span></button>
        </div>
    </div>
  );
}

// --- SUBCOMPONENTE DE HISTORIAL ---
function HistoryViewSafe({ history, loading }) {
    if (loading) return <div className="flex flex-col items-center justify-center h-[60vh] text-blue-500"><RefreshCw className="animate-spin mb-2"/> Cargando...</div>;
    if (!history || history.length === 0) return <div className="flex flex-col items-center justify-center h-[60vh] text-gray-400"><Database size={48} className="mb-4 opacity-50"/><p>No se encontraron datos.</p></div>;

    const [filterDate, setFilterDate] = useState('all');
    const [expandedId, setExpandedId] = useState(null);

    // Calculos Seguros (Memo)
    const availableMonths = useMemo(() => {
        const uniqueMonths = new Set();
        history.forEach(h => {
            const d = new Date(h.date);
            if (!isNaN(d.getTime())) {
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('es-AR', { month: 'long', year: 'numeric' });
                uniqueMonths.add(JSON.stringify({ value, label: label.charAt(0).toUpperCase() + label.slice(1) }));
            }
        });
        return Array.from(uniqueMonths).map(s => JSON.parse(s)).sort((a,b) => b.value.localeCompare(a.value));
    }, [history]);

    const pieData = useMemo(() => {
        const source = filterDate === 'all' ? history : history.filter(h => h.date.startsWith(filterDate));
        const catMap = {};
        let totalAll = 0;
        source.forEach(h => {
            if (h.items) h.items.forEach(item => {
                const sub = (item.actualQty || 0) * (item.price || 0);
                const cat = item.category || 'Varios';
                catMap[cat] = (catMap[cat] || 0) + sub;
                totalAll += sub;
            });
        });
        return Object.entries(catMap).map(([k,v]) => ({ name: k, value: v, percent: totalAll ? (v/totalAll)*100 : 0 })).sort((a,b)=>b.value - a.value);
    }, [history, filterDate]);

    const monthlyData = useMemo(() => {
        const months = Array.from({length: 12}, (_, i) => ({
            label: new Date(2024, i, 1).toLocaleString('es-AR', { month: 'short' }).toUpperCase(),
            total: 0
        }));
        history.forEach(h => {
            const d = new Date(h.date);
            if (!isNaN(d.getTime())) months[d.getMonth()].total += (h.total || 0);
        });
        return months;
    }, [history]);

    const maxMonthly = Math.max(...monthlyData.map(d => d.total), 1);
    const pieGradient = pieData.length > 0 ? pieData.reduce((acc, cat, idx) => {
        const prev = pieData.slice(0, idx).reduce((p, c) => p + c.percent, 0);
        const color = COLORS.chartColors[idx % COLORS.chartColors.length];
        return `${acc}, ${color} ${prev}% ${prev + cat.percent}%`;
    }, '').slice(2) : '#ddd 0% 100%';

    return (
        <div className="p-4 space-y-6 pb-24">
            {/* Torta */}
            <div className="bg-white rounded-xl shadow-sm border p-4">
                <div className="flex justify-between items-start mb-4">
                    <h3 className="font-bold text-gray-700 flex items-center gap-2"><PieChart size={18} className="text-blue-500"/> Gasto por Rubro</h3>
                    <div className="relative">
                        <select value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="appearance-none bg-gray-100 text-gray-700 text-xs font-bold py-1 pl-3 pr-8 rounded-lg border focus:outline-none">
                            <option value="all">Todo el Año</option>
                            {availableMonths.map(m => (<option key={m.value} value={m.value}>{m.label}</option>))}
                        </select>
                        <ChevronDown size={14} className="absolute right-2 top-1.5 text-gray-500 pointer-events-none" />
                    </div>
                </div>
                <div className="flex flex-row items-center gap-4">
                    <div className="w-32 h-32 rounded-full relative shadow-inner flex-shrink-0" style={{ background: `conic-gradient(${pieGradient})` }}>
                        <div className="absolute inset-8 bg-white rounded-full flex items-center justify-center flex-col"><span className="text-[9px] text-gray-400 font-bold uppercase">TOTAL</span><span className="text-xs font-bold text-gray-700">${Math.round(pieData.reduce((a,b)=>a+b.value,0)/1000)}k</span></div>
                    </div>
                    <div className="flex-1 space-y-1">
                        {pieData.length > 0 ? pieData.slice(0, 5).map((cat, idx) => (
                            <div key={idx} className="flex justify-between items-center text-xs">
                                <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.chartColors[idx % COLORS.chartColors.length] }}></div><span className="text-gray-600 truncate max-w-[80px]">{cat.name}</span></div>
                                <span className="font-bold">{Math.round(cat.percent)}%</span>
                            </div>
                        )) : <div className="text-xs text-gray-400 italic">Sin datos</div>}
                    </div>
                </div>
            </div>

            {/* Barras */}
            <div className="bg-white rounded-xl shadow-sm border p-4">
                <h3 className="font-bold text-gray-700 mb-4">Evolución Anual</h3>
                <div className="flex items-end gap-1 h-32 border-b pb-2">
                    {monthlyData.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col items-center gap-1 h-full justify-end group">
                            <div className="w-full relative flex items-end justify-center h-full">
                                <div className="w-full rounded-t-sm transition-all relative" style={{ height: d.total > 0 ? `${(d.total/maxMonthly)*100}%` : '4px', backgroundColor: d.total > 0 ? (i%2===0 ? COLORS.barColor1 : COLORS.barColor2) : COLORS.pastelGray }}>
                                    {d.total > 0 && <div className="opacity-0 group-hover:opacity-100 absolute -top-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[9px] px-1 rounded pointer-events-none transition-opacity z-10 whitespace-nowrap">${Math.round(d.total/1000)}k</div>}
                                </div>
                            </div>
                            <span className={`text-[8px] font-bold uppercase ${d.total > 0 ? 'text-gray-700' : 'text-gray-300'}`}>{d.label}</span>
                        </div>
                    ))}
                </div>
            </div>

            {/* Lista Acordeón */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div className="bg-gray-50 px-4 py-2 border-b font-bold text-xs text-gray-500">HISTORIAL DE TICKETS</div>
                {history.map((h, i) => (
                    <div key={h.id + i} className="border-b border-gray-100 last:border-0">
                        <div onClick={() => setExpandedId(expandedId === h.id ? null : h.id)} className={`px-4 py-3 flex justify-between items-center cursor-pointer transition-colors ${expandedId === h.id ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                            <div><div className="font-bold text-sm text-gray-800">{h.displayDate}</div><div className="text-[10px] text-gray-400">{h.items.length} productos</div></div>
                            <div className="flex items-center gap-2"><span className="font-bold text-blue-600">${h.total.toLocaleString('es-AR')}</span>{expandedId === h.id ? <ChevronUp size={16} className="text-gray-400" /> : <ChevronDown size={16} className="text-gray-400" />}</div>
                        </div>
                        {expandedId === h.id && (
                            <div className="bg-gray-50 p-3 text-xs border-t border-gray-100 animate-in slide-in-from-top-1 fade-in duration-200">
                                {h.items.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-start mb-2 last:mb-0 border-b border-gray-100 last:border-0 pb-2 last:pb-0 border-dashed">
                                        <div className="flex-1 pr-2">
                                            <div className="font-medium text-gray-700"><span className="font-bold text-blue-600 mr-1">{item.actualQty}x</span>{item.name}</div>
                                            <div className="text-[10px] text-gray-500 mt-0.5">{item.brand} • <span className="uppercase text-[9px] bg-gray-200 px-1 rounded">{item.category}</span></div>
                                        </div>
                                        <div className="font-medium text-gray-600 whitespace-nowrap">${item.price.toLocaleString('es-AR')}</div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}

// Wrapper para el ErrorBoundary
export function AppWrapper() {
  return (
    <ErrorBoundary>
      <NiniAppFull />
    </ErrorBoundary>
  );
}
