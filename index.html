<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nini Cloud</title>
    
    <!-- PWA Setup -->
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://i.imgur.com/23tlEnQ.jpeg">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk5pbmkgQ2xvdWQiLAogICJzaG9ydF9uYW1lIjogIk5pbmkiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2kuaW1ndXIuY29tLzIzdGxFblEuanBlZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvanBlZyIKICAgIH0KICBdCn0=">

    <!-- Estilos y Motores -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- CONEXI√ìN A FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, orderBy, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Exponer herramientas al entorno global
        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, updateProfile, getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, orderBy, writeBatch, deleteDoc, getDocs };
        
        // Avisar que Firebase carg√≥
        window.firebaseLoaded = true;
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select { font-size: 16px; } /* Evita zoom iOS */
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <!-- LOADING INICIAL (Para que no se vea blanco mientras carga React) -->
    <div id="root">
        <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#004aad;">
            <img src="https://i.imgur.com/23tlEnQ.jpeg" style="width:100px; margin-bottom:20px; border-radius:15px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.1);">
            <div style="font-weight:bold; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">Cargando App...</div>
        </div>
    </div>

    <!-- L√ìGICA DE LA APP -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- TUS CLAVES (NO TOCAR) ---
        const firebaseConfig = {
          apiKey: "AIzaSyD1XQbCn5DjBr6mSJ2LyAihW6_pRpcMdLs",
          authDomain: "nini-app-61a6a.firebaseapp.com",
          projectId: "nini-app-61a6a",
          storageBucket: "nini-app-61a6a.firebasestorage.app",
          messagingSenderId: "1019944365082",
          appId: "1:1019944365082:web:3e921a4207a846306235a3"
        };
        const SHEET_ID = "1Yz_Br2J41diPtd-PL8lLE_Q8eQex-Vf7ifkIqdEqQEQ";
        const LINK_HOJA_PRODUCTOS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_PRODUCTOS`; 
        const LINK_HOJA_HISTORIAL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=LINK_HOJA_HISTORIAL`;

        const COLORS = {
            blue: '#004aad', red: '#e31d2b', bg: '#f8f9fa',
            bar1: '#93C5FD', bar2: '#60A5FA', gray: '#E5E7EB',
            pie: ['#93C5FD', '#FCA5A5', '#86EFAC', '#FDE047', '#D8B4FE', '#F9A8D4', '#67E8F9']
        };

        // --- ICONOS INDESTRUCTIBLES ---
        const Icon = ({ p, s=24, c="" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}>{p}</svg> );
        const Icons = {
            Search: <Icon p={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} s={16}/>,
            Trash: <Icon p={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Plus: <Icon p={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Minus: <Icon p={<path d="M5 12h14"/>} />,
            Lock: <Icon p={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            Unlock: <Icon p={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>} />,
            Filter: <Icon p={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Save: <Icon p={<><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></>} />,
            List: <Icon p={<><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>} />,
            Pie: <Icon p={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />,
            Db: <Icon p={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            Copy: <Icon p={<><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>} />,
            X: <Icon p={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Down: <Icon p={<path d="m6 9 6 6 6-6"/>} />,
            Up: <Icon p={<path d="m18 15-6-6-6 6"/>} />,
            Download: <Icon p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            User: <Icon p={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Settings: <Icon p={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            LogOut: <Icon p={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Google: <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            // ESTADOS
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); // login | list | history
            const [products, setProducts] = useState([]);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fb, setFb] = useState(null);
            
            // UI States
            const [searchTerm, setSearchTerm] = useState('');
            const [catFilter, setCatFilter] = useState('Todos');
            const [brandFilter, setBrandFilter] = useState('Todas');
            const [showBrandFilter, setShowBrandFilter] = useState(false);
            const [isLocked, setIsLocked] = useState(() => localStorage.getItem('nini_lock') === 'true');
            const [showAdd, setShowAdd] = useState(false);
            const [showExport, setShowExport] = useState(false);
            const [exportTxt, setExportTxt] = useState('');
            const [statusMsg, setStatusMsg] = useState('');

            // 1. INICIALIZAR FIREBASE
            useEffect(() => {
                const init = () => {
                    if (window.FirebaseSDK) {
                        try {
                            const { initializeApp, getAuth, getFirestore, onAuthStateChanged, signInAnonymously, GoogleAuthProvider, signInWithPopup } = window.FirebaseSDK;
                            const app = initializeApp(firebaseConfig);
                            const auth = getAuth(app);
                            const db = getFirestore(app);
                            setFb({ auth, db, signInAnonymously, GoogleAuthProvider, signInWithPopup });

                            onAuthStateChanged(auth, (u) => {
                                setUser(u);
                                setLoading(false);
                                if(u) setView('list'); else setView('login');
                            });
                        } catch(e) { console.error(e); setLoading(false); }
                    } else { setTimeout(init, 500); }
                };
                init();
            }, []);

            // 2. ESCUCHAR DATOS + AUTO-IMPORT
            useEffect(() => {
                if(!user || !fb) return;
                const { db, onSnapshot, collection, query, orderBy, doc, writeBatch } = window.FirebaseSDK;

                // PRODUCTOS
                const prodRef = collection(db, `users/${user.uid}/products`);
                const unsubProd = onSnapshot(prodRef, (snap) => {
                    if(snap.empty) {
                        // SI ESTA VACIO, IMPORTAMOS AUTOMATICAMENTE DEL SHEET
                        if(!localStorage.getItem(`imported_${user.uid}`)) {
                            setStatusMsg("Cargando tu cat√°logo...");
                            autoImport(fb.db, user.uid);
                            localStorage.setItem(`imported_${user.uid}`, 'true');
                        }
                    } else {
                        const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        setProducts(items.sort((a,b) => (a.name||'').localeCompare(b.name||'')));
                    }
                });

                // HISTORIAL
                const histRef = query(collection(db, `users/${user.uid}/history`), orderBy("date", "desc"));
                const unsubHist = onSnapshot(histRef, (snap) => {
                    const items = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setHistory(items);
                });

                return () => { unsubProd(); unsubHist(); };
            }, [user, fb]);

            useEffect(() => localStorage.setItem('nini_lock', isLocked), [isLocked]);

            // FUNCION AUTO IMPORTAR (SHEET -> FIREBASE)
            const autoImport = async (db, uid) => {
                try {
                    // Productos
                    const resP = await fetch(LINK_HOJA_PRODUCTOS_URL);
                    const txtP = await resP.text();
                    const linesP = txtP.split('\n').slice(1);
                    const { collection, writeBatch, doc } = window.FirebaseSDK;
                    let batch = writeBatch(db);
                    let count = 0;

                    linesP.forEach(line => {
                        const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(t => t.replace(/^"|"$/g,'').trim());
                        if(c.length < 2) return;
                        const name = c[1]; if(!name) return;
                        const ref = doc(collection(db, `users/${uid}/products`));
                        batch.set(ref, {
                            name, brand: c[2]||'Gen√©rico', category: c[3]||'Varios', 
                            price: parseFloat(c[4].replace('.','').replace(',','.')) || 0,
                            plannedQty: 0, actualQty: 0
                        });
                        count++;
                        if(count % 400 === 0) { batch.commit(); batch = writeBatch(db); }
                    });
                    await batch.commit();

                    // Historial
                    const resH = await fetch(LINK_HOJA_HISTORIAL_URL);
                    const txtH = await resH.text();
                    const linesH = txtH.split('\n').slice(1);
                    const groups = {};
                    linesH.forEach(line => {
                        const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(t => t.replace(/^"|"$/g,'').trim());
                        if(c.length < 6) return;
                        const date = c[0]; if(!date) return;
                        if(!groups[date]) groups[date] = { total: 0, items: [] };
                        const qty = parseFloat(c[4])||0; const price = parseFloat(c[5])||0;
                        groups[date].items.push({ name: c[1], brand: c[2], category: c[3]||'Varios', actualQty: qty, price });
                        groups[date].total += qty * price;
                    });
                    
                    batch = writeBatch(db);
                    count = 0;
                    Object.keys(groups).forEach(dStr => {
                        let iso = new Date().toISOString();
                        if(dStr.includes('/')) {
                            const [d,m,y] = dStr.split('/');
                            iso = new Date(`${y.length===2?'20'+y:y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T12:00:00`).toISOString();
                        }
                        const ref = doc(collection(db, `users/${uid}/history`));
                        batch.set(ref, { date: iso, displayDate: dStr, total: groups[dStr].total, items: groups[dStr].items });
                        count++;
                        if(count % 400 === 0) { batch.commit(); batch = writeBatch(db); }
                    });
                    await batch.commit();
                    setStatusMsg('');
                } catch(e) { console.error("Import error", e); setStatusMsg(''); }
            };

            // ACCIONES DB
            const updateProd = (id, data) => {
                setProducts(p => p.map(i => i.id === id ? {...i, ...data} : i)); // Optimistic
                if(fb && user) {
                    const { doc, updateDoc } = window.FirebaseSDK;
                    updateDoc(doc(fb.db, `users/${user.uid}/products`, id), data);
                }
            };
            
            const addProd = (item) => {
                setProducts(p => [item, ...p]);
                if(fb && user) {
                    const { collection, addDoc } = window.FirebaseSDK;
                    addDoc(collection(fb.db, `users/${user.uid}/products`), item);
                }
            };

            const finishPurchase = async () => {
                const bought = products.filter(p => p.actualQty > 0);
                if(bought.length === 0) return alert("Carrito vac√≠o");
                if(!confirm("¬øGuardar compra y limpiar?")) return;
                
                const total = bought.reduce((acc,p) => acc + (p.price*p.actualQty), 0);
                const item = { date: new Date().toISOString(), total, items: bought };
                
                if(fb && user) {
                    const { collection, addDoc, doc, writeBatch } = window.FirebaseSDK;
                    const batch = writeBatch(fb.db);
                    // Add history
                    const hRef = doc(collection(fb.db, `users/${user.uid}/history`));
                    batch.set(hRef, item);
                    // Reset products
                    bought.forEach(p => {
                        const pRef = doc(fb.db, `users/${user.uid}/products`, p.id);
                        batch.update(pRef, { actualQty: 0 });
                    });
                    await batch.commit();
                }
                setProducts(prev => prev.map(p => ({...p, actualQty: 0})));
                setView('history');
            };

            const handleLogout = async () => {
                if(fb) { await window.FirebaseSDK.signOut(fb.auth); window.location.reload(); }
            };

            // RENDER
            if(loading) return <div className="h-screen flex flex-col items-center justify-center text-blue-600 font-bold gap-4"><div className="animate-spin">{Icons.RefreshCw}</div>Cargando Nube...</div>;

            if(!user) return <LoginScreen onGoogle={async ()=>{ try{ const p = new window.FirebaseSDK.GoogleAuthProvider(); await fb.signInWithPopup(fb.auth, p); }catch(e){alert("Error Login: "+e.message)} }} onAnon={async ()=> { try{ await fb.signInAnonymously(fb.auth); }catch(e){alert("Error Anon: "+e.message)} }} />;

            return (
                <div className="min-h-screen bg-gray-50 pb-20 font-sans flex flex-col">
                    {/* Header */}
                    <div className="sticky top-0 z-50 bg-white shadow-sm">
                        <div className="flex justify-between items-center px-4 py-2 bg-white">
                            <div className="h-10 w-32 flex items-center overflow-hidden"><img src="https://i.imgur.com/23tlEnQ.jpeg" className="h-full w-full object-contain scale-150 origin-left" /></div>
                            
                            {view === 'list' ? (
                                <div className="flex items-center gap-2">
                                    <div className="bg-gray-50 border px-3 py-1 rounded-lg flex items-center gap-3 shadow-sm">
                                        <div className="flex flex-col items-end"><span className="text-[9px] font-bold text-gray-400 uppercase">Plan</span><span className="text-xs font-bold">${products.reduce((a,b)=>a+(b.price*(b.plannedQty||0)),0)}</span></div>
                                        <div className="w-px h-6 bg-gray-200"></div>
                                        <div className="flex flex-col items-end"><span className="text-[9px] font-bold text-green-600 uppercase">Carrito</span><span className="text-xl font-black text-gray-800 leading-none">${products.reduce((a,b)=>a+(b.price*(b.actualQty||0)),0)}</span></div>
                                    </div>
                                    <button onClick={finishPurchase} className="bg-blue-600 text-white p-2 rounded-full shadow hover:bg-blue-700 active:scale-95 transition-transform">{Icons.Save}</button>
                                </div>
                            ) : (
                                <div className="text-xs font-bold text-green-600 bg-green-50 px-3 py-1 rounded border border-green-200">En L√≠nea</div>
                            )}
                            <button onClick={()=>setShowSettings(true)} className="p-2 text-gray-400">{Icons.Settings}</button>
                        </div>
                        {view === 'list' && user && <div className="bg-blue-50 px-4 py-1 text-[10px] text-blue-800 font-bold flex justify-between"><span>Hola, {user.displayName || 'Invitado'} üëã</span><span>Nini Cloud</span></div>}
                    </div>

                    {/* Body */}
                    <div className="flex-1 overflow-y-auto">
                        {view === 'list' ? (
                            <ListView 
                                products={products} onUpdate={updateProd} 
                                filter={filter} setFilter={setFilter} 
                                brandFilter={brandFilter} setBrandFilter={setBrandFilter} showBrandFilter={showBrandFilter} setShowBrandFilter={setShowBrandFilter}
                                searchTerm={searchTerm} setSearchTerm={setSearchTerm} 
                                isLocked={isLocked} setIsLocked={setIsLocked} 
                                onClear={() => products.forEach(p => p.actualQty > 0 && updateProd(p.id, {actualQty:0}))}
                                onAdd={() => setShowAddModal(true)}
                            />
                        ) : (
                            <HistoryView history={history} />
                        )}
                    </div>

                    {/* Nav */}
                    <div className="fixed bottom-0 w-full flex justify-around items-center pb-safe z-50 h-16 shadow-[0_-5px_10px_rgba(0,0,0,0.05)]" style={{backgroundColor: COLORS.blue}}>
                        <button onClick={()=>setView('list')} className={`flex flex-col items-center w-full h-full justify-center ${view==='list'?'text-white':'text-white/50'}`}>{Icons.List}<span className="text-[10px] font-bold mt-1">Lista</span></button>
                        <button onClick={()=>setView('history')} className={`flex flex-col items-center w-full h-full justify-center ${view==='history'?'text-white':'text-white/50'}`}>{Icons.PieChart}<span className="text-[10px] font-bold mt-1">Historial</span></button>
                    </div>

                    {/* Modales */}
                    {statusMsg && <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-black/80 text-white text-xs px-4 py-2 rounded-full shadow-lg z-50 animate-pulse">{statusMsg}</div>}
                    
                    {showAddModal && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                            <form onSubmit={e => {
                                e.preventDefault(); const fd = new FormData(e.target);
                                addProd({ name: fd.get('name'), brand: fd.get('brand')||'Gen√©rico', category: fd.get('cat')||'Varios', price: parseFloat(fd.get('price'))||0, plannedQty: 0, actualQty: 1 });
                                setShowAddModal(false);
                            }} className="bg-white p-5 rounded-xl w-full max-w-xs shadow-2xl">
                                <div className="flex justify-between mb-4"><h3 className="font-bold">Agregar</h3><button type="button" onClick={()=>setShowAddModal(false)}>{Icons.X}</button></div>
                                <input name="name" className="w-full border p-2 mb-2 rounded" placeholder="Nombre" required autoFocus/>
                                <div className="flex gap-2 mb-2"><input name="brand" className="w-full border p-2 rounded" placeholder="Marca"/><input name="price" type="number" className="w-full border p-2 rounded" placeholder="Precio"/></div>
                                <select name="cat" className="w-full border p-2 mb-4 rounded"><option value="Almac√©n">Almac√©n</option><option value="Bebidas">Bebidas</option><option value="Limpieza">Limpieza</option><option value="Varios">Varios</option></select>
                                <button className="w-full bg-blue-600 text-white font-bold py-3 rounded">Guardar</button>
                            </form>
                        </div>
                    )}

                    {showSettings && (
                        <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-5 space-y-4">
                                <div className="flex justify-between"><h3 className="font-bold">Cuenta</h3><button onClick={()=>setShowSettings(false)}>{Icons.X}</button></div>
                                <div className="text-xs text-gray-500 break-all">ID: {user.uid}</div>
                                <button onClick={handleLogout} className="w-full py-3 border border-red-200 text-red-600 rounded font-bold flex items-center justify-center gap-2">{Icons.LogOut} Cerrar Sesi√≥n</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- PANTALLA LOGIN ---
        const LoginScreen = ({ onGoogle, onAnon }) => (
            <div className="h-screen flex flex-col items-center justify-center p-8 text-white text-center" style={{background: `linear-gradient(to bottom, ${COLORS.blue}, #002a60)`}}>
                <img src="https://i.imgur.com/23tlEnQ.jpeg" className="w-32 rounded-3xl shadow-2xl mb-6"/>
                <h1 className="text-2xl font-black mb-2">Mi Nini App</h1>
                <p className="text-blue-200 text-sm mb-8">Tus compras, organizadas.</p>
                <div className="w-full max-w-xs space-y-3">
                    <button onClick={onGoogle} className="bg-white text-gray-800 w-full py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition">
                        {Icons.Google} Continuar con Google
                    </button>
                    <button onClick={onAnon} className="text-xs text-blue-300 hover:text-white underline">Entrar como invitado</button>
                </div>
            </div>
        );

        // --- VISTA LISTA ---
        const ListView = ({ products, onUpdate, filter, setFilter, brandFilter, setBrandFilter, showBrandFilter, setShowBrandFilter, searchTerm, setSearchTerm, isLocked, setIsLocked, onClear, onAdd }) => {
            const cats = ['Todos', ...new Set(products.map(p => p.category || 'Varios'))].sort();
            const brands = ['Todas', ...new Set(products.filter(p => filter === 'Todos' || p.category === filter).map(p => p.brand || 'Gen√©rico'))].sort();
            const filtered = products.filter(p => (filter === 'Todos' || p.category === filter) && (brandFilter === 'Todas' || p.brand === brandFilter) && p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div>
                    <div className="bg-white p-3 border-b flex flex-col gap-3">
                        <div className="bg-gray-50 border-dashed border border-gray-200 rounded p-2 text-center text-[10px] text-gray-400">ESPACIO PUBLICIDAD</div>
                        <div className="flex gap-2">
                             <button onClick={() => setIsLocked(!isLocked)} className={`w-10 h-10 flex items-center justify-center rounded-lg border ${isLocked ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-gray-50 text-gray-400'}`}>{isLocked ? Icons.Lock : Icons.Unlock}</button>
                             <div className="relative flex-1 flex gap-2">
                                <div className="relative flex-1"><span className="absolute left-3 top-2 text-gray-400">{Icons.Search}</span><input className="w-full h-10 pl-9 pr-3 rounded-lg border bg-gray-50 focus:bg-white focus:border-blue-500 outline-none text-sm" placeholder="Buscar..." onChange={e=>setSearchTerm(e.target.value)}/></div>
                                <button onClick={onAdd} className="bg-blue-600 text-white w-10 rounded flex items-center justify-center shadow active:scale-95">{Icons.Plus}</button>
                             </div>
                             <button onClick={() => setShowBrandFilter(!showBrandFilter)} className={`w-10 h-10 rounded-lg border flex items-center justify-center ${showBrandFilter ? 'bg-blue-100 text-blue-700' : 'text-gray-400'}`}>{Icons.Filter}</button>
                             <button onClick={onClear} className="w-10 h-10 text-gray-400 hover:text-red-500 flex items-center justify-center">{Icons.Trash2}</button>
                        </div>
                        {showBrandFilter && <div className="px-3 py-2 bg-blue-50 rounded border border-blue-100"><div className="text-[10px] font-bold text-blue-800 mb-1 uppercase">Marca</div><select value={brandFilter} onChange={e => setBrandFilter(e.target.value)} className="w-full p-2 text-sm border rounded bg-white"><option value="Todas">Todas</option>{brands.map(b => <option key={b} value={b}>{b}</option>)}</select></div>}
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">{cats.map(c => (<button key={c} onClick={() => setFilter(c)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filter === c ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'}`}>{c}</button>))}</div>
                    </div>
                    <div className="pb-4">
                        {filtered.map(p => (
                            <div key={p.id} className={`flex items-center px-4 py-4 border-b transition-colors ${p.actualQty > 0 ? 'bg-green-50' : 'bg-white'}`}>
                                <div className="flex-1 min-w-0 pr-2">
                                    <div className="font-bold text-gray-800 text-lg truncate">{p.name}</div>
                                    <div className="text-xs text-gray-500 truncate">{p.brand} ‚Ä¢ {p.category}</div>
                                    <div className="flex items-center mt-1"><span className="text-sm text-gray-400 mr-1">$</span><input type="number" className="font-bold text-gray-700 w-20 bg-transparent border-b border-dashed outline-none" value={p.price} onChange={e=>onUpdate(p.id, {price: Number(e.target.value)})} /></div>
                                </div>
                                <div className={`w-16 flex items-center justify-center border-x border-gray-100 px-1 ${isLocked ? 'opacity-40 pointer-events-none' : ''}`}>
                                    <button onClick={() => onUpdate(p.id, { plannedQty: Math.max(0, (p.plannedQty||0)-1) })} className="px-1 text-gray-400">{Icons.Minus}</button>
                                    <span className="font-bold text-gray-600 w-6 text-center text-lg">{p.plannedQty||0}</span>
                                    <button onClick={() => onUpdate(p.id, { plannedQty: (p.plannedQty||0)+1 })} className="px-1 text-gray-400">{Icons.Plus}</button>
                                </div>
                                <div className="w-28 flex items-center justify-between pl-3">
                                    <button onClick={() => onUpdate(p.id, { actualQty: Math.max(0, (p.actualQty||0)-1) })} className="w-10 h-10 bg-white border rounded shadow-sm flex items-center justify-center text-gray-600">{Icons.Minus}</button>
                                    <span className={`text-xl font-bold ${p.actualQty > 0 ? 'text-green-600' : 'text-blue-900'}`}>{p.actualQty||0}</span>
                                    <button onClick={() => onUpdate(p.id, { actualQty: (p.actualQty||0)+1 })} className="w-10 h-10 bg-blue-600 text-white rounded shadow-md flex items-center justify-center active:scale-95">{Icons.Plus}</button>
                                </div>
                            </div>
                        ))}
                        {filtered.length === 0 && <div className="text-center py-10 text-gray-400">Sin productos.</div>}
                    </div>
                </div>
            );
        };

        // --- VISTA HISTORIAL ---
        const HistoryView = ({ history }) => {
            const [filterDate, setFilterDate] = useState('all');
            const [expandedId, setExpandedId] = useState(null);

            const months = useMemo(() => Array.from(new Set(history.map(h => new Date(h.date).toLocaleString('es-AR', {month:'long', year:'numeric'})))), [history]);
            const pieData = useMemo(() => {
                const map = {}; let tot = 0;
                const src = filterDate === 'all' ? history : history.filter(h => new Date(h.date).toLocaleString('es-AR', {month:'long', year:'numeric'}) === filterDate);
                src.forEach(h => h.items.forEach(i => { const v = i.actualQty*i.price; map[i.category] = (map[i.category]||0)+v; tot+=v; }));
                return Object.entries(map).map(([k,v]) => ({name:k, value:v, percent: tot?(v/tot)*100:0})).sort((a,b)=>b.value-a.value);
            }, [history, filterDate]);
            const bars = useMemo(() => {
                const arr = Array(12).fill(0);
                history.forEach(h => { const d = new Date(h.date); if(!isNaN(d)) arr[d.getMonth()] += h.total; });
                return arr.map((t,i) => ({ label: new Date(2024, i, 1).toLocaleString('es-AR', {month:'short'}).toUpperCase(), total: t }));
            }, [history]);
            const maxBar = Math.max(...bars.map(b=>b.total), 1);
            const totalYear = bars.reduce((a,b)=>a+b.total,0);

            return (
                <div className="p-4 space-y-6 pb-24">
                    <div className="bg-white rounded-xl shadow border p-4">
                        <div className="flex justify-between mb-4"><h3 className="font-bold text-gray-700 flex gap-2 text-blue-600">{Icons.PieChart} Gasto por Rubro</h3><select onChange={e=>setFilterDate(e.target.value)} className="text-xs border rounded bg-gray-50"><option value="all">Todo el A√±o</option>{months.map(m=><option key={m} value={m}>{m}</option>)}</select></div>
                        <div className="flex items-center gap-4">
                            <div className="w-32 h-32 rounded-full border-4 border-blue-100 flex items-center justify-center flex-col"><span className="text-[9px] text-gray-400">TOTAL</span><span className="text-xs font-bold">${Math.round(pieData.reduce((a,b)=>a+b.value,0)/1000)}k</span></div>
                            <div className="flex-1 space-y-1">{pieData.slice(0,5).map((c,i)=>(<div key={i} className="flex justify-between text-xs"><span>{c.name}</span><span className="font-bold">{Math.round(c.percent)}%</span></div>))}</div>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow border p-4">
                        <div className="flex justify-between mb-4"><h3 className="font-bold text-gray-700">Evoluci√≥n</h3><span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Total: ${totalYear.toLocaleString('es-AR')}</span></div>
                        <div className="flex items-end gap-1 h-32 border-b pb-2">{bars.map((b,i)=>(<div key={i} className="flex-1 flex flex-col items-center gap-1 h-full justify-end group"><div className="w-full relative flex items-end justify-center h-full"><div className="w-full rounded-t-sm" style={{height: b.total>0?`${(b.total/maxBar)*100}%`:'4px', background: b.total>0?(i%2===0?COLORS.bar1:COLORS.bar2):COLORS.pastelGray}}></div></div><span className="text-[8px] font-bold text-gray-500">{b.label}</span></div>))}</div>
                    </div>
                    <div className="bg-white rounded-xl shadow border overflow-hidden">
                        <div className="bg-gray-50 px-4 py-2 border-b font-bold text-xs text-gray-500">HISTORIAL</div>
                        {history.map(h => (
                            <div key={h.id} className="border-b last:border-0">
                                <div onClick={()=>setExpandedId(expandedId===h.id?null:h.id)} className="px-4 py-3 flex justify-between items-center hover:bg-gray-50">
                                    <div><div className="font-bold text-sm">{new Date(h.date).toLocaleDateString('es-AR')}</div><div className="text-xs text-gray-400">{h.items.length} items</div></div>
                                    <div className="font-bold text-blue-600">${h.total.toLocaleString('es-AR')}</div>
                                </div>
                                {expandedId === h.id && <div className="bg-gray-50 p-3 text-xs border-t">{h.items.map((i,idx)=><div key={idx} className="flex justify-between mb-1 pb-1 border-b border-dashed last:border-0"><span>{i.actualQty}x {i.name}</span><span>${i.price}</span></div>)}</div>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


